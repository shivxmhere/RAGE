<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
   <title>RAGE OS ‚Äî Rise. Act. Grow. Excel.</title>
   <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
   <meta name="description" content="RAGE OS ‚Äî Personal Life Operating System">
   <link rel="preconnect" href="https://fonts.googleapis.com">
   <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@500;600;700&family=DM+Mono:wght@400;500&display=swap"
      rel="stylesheet">
   <style>
      :root {
         --bg1: #060910;
         --bg2: #0A0F1E;
         --card: #0D1526;
         --card2: #111827;
         --cyan: #00F5FF;
         --orange: #FF6B35;
         --green: #39FF14;
         --purple: #7C3AED;
         --text: #E8F4F8;
         --muted: #4A6580;
         --border: rgba(0, 245, 255, 0.12);
         --glow-c: rgba(0, 245, 255, 0.15);
         --glow-o: rgba(255, 107, 53, 0.15);
         --font-d: 'Orbitron', sans-serif;
         --font-t: 'Rajdhani', sans-serif;
         --font-b: 'DM Mono', monospace;
         --r-sm: 8px;
         --r-md: 16px;
         --r-lg: 20px;
         --r-nav: 24px;
         --r-full: 50%;
      }

      * {
         margin: 0;
         padding: 0;
         box-sizing: border-box;
      }

      html,
      body {
         height: 100%;
         background: var(--bg1);
         color: var(--text);
         font-family: var(--font-b);
         overflow: hidden;
      }

      .screen {
         display: none;
         position: absolute;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         overflow-y: auto;
         overflow-x: hidden;
         padding-bottom: 90px;
      }

      .screen.active {
         display: flex;
         flex-direction: column;
      }

      .screen.no-pad {
         padding-bottom: 0;
      }

      button {
         cursor: pointer;
         border: none;
         outline: none;
         font-family: var(--font-t);
         transition: transform .15s, box-shadow .2s;
      }

      button:active {
         transform: scale(0.96);
      }

      input,
      select,
      textarea {
         background: var(--card);
         border: 1px solid var(--border);
         color: var(--text);
         font-family: var(--font-b);
         padding: 12px 16px;
         border-radius: var(--r-sm);
         width: 100%;
         font-size: 14px;
         outline: none;
         transition: border .2s, box-shadow .2s;
      }

      input:focus,
      textarea:focus {
         border-color: var(--cyan);
         box-shadow: 0 0 12px var(--glow-c);
      }

      ::-webkit-scrollbar {
         width: 4px;
      }

      ::-webkit-scrollbar-track {
         background: var(--bg2);
      }

      ::-webkit-scrollbar-thumb {
         background: var(--muted);
         border-radius: 4px;
      }

      .btn-cyan {
         background: linear-gradient(135deg, var(--cyan), #00c4cc);
         color: var(--bg1);
         font-family: var(--font-d);
         font-weight: 700;
         padding: 14px 24px;
         border-radius: var(--r-sm);
         width: 100%;
         font-size: 15px;
         letter-spacing: 1px;
         box-shadow: 0 0 20px rgba(0, 245, 255, 0.3);
      }

      .btn-cyan:hover {
         box-shadow: 0 0 30px rgba(0, 245, 255, 0.5);
         transform: translateY(-2px);
      }

      .btn-orange {
         background: linear-gradient(135deg, var(--orange), #e05520);
         color: #fff;
         font-family: var(--font-d);
         font-weight: 700;
         padding: 14px 24px;
         border-radius: var(--r-sm);
         width: 100%;
         font-size: 15px;
         letter-spacing: 1px;
         box-shadow: 0 0 20px var(--glow-o);
      }

      .btn-outline {
         background: transparent;
         border: 1px solid var(--cyan);
         color: var(--cyan);
         font-family: var(--font-t);
         font-weight: 600;
         padding: 10px 20px;
         border-radius: var(--r-sm);
      }

      .card {
         background: var(--card);
         border: 1px solid var(--border);
         border-radius: var(--r-md);
         padding: 20px;
         position: relative;
         overflow: hidden;
      }

      .card::before {
         content: '';
         position: absolute;
         top: 0;
         left: 0;
         right: 0;
         height: 1px;
         background: linear-gradient(90deg, transparent, var(--cyan), transparent);
         animation: scanline 3s infinite;
         opacity: 0.5;
      }

      .card:hover {
         transform: translateY(-2px);
         border-color: rgba(0, 245, 255, 0.3);
         box-shadow: 0 0 20px var(--glow-c);
      }

      .tag {
         display: inline-block;
         padding: 4px 10px;
         border-radius: 20px;
         font-size: 11px;
         font-family: var(--font-b);
         font-weight: 500;
      }

      .tag-cyan {
         background: rgba(0, 245, 255, 0.1);
         color: var(--cyan);
         border: 1px solid rgba(0, 245, 255, 0.2);
      }

      .tag-orange {
         background: rgba(255, 107, 53, 0.1);
         color: var(--orange);
         border: 1px solid rgba(255, 107, 53, 0.2);
      }

      .tag-green {
         background: rgba(57, 255, 20, 0.1);
         color: var(--green);
         border: 1px solid rgba(57, 255, 20, 0.2);
      }

      .tag-purple {
         background: rgba(124, 58, 237, 0.1);
         color: var(--purple);
         border: 1px solid rgba(124, 58, 237, 0.2);
      }

      @keyframes scanline {

         0%,
         100% {
            opacity: 0;
         }

         50% {
            opacity: 0.6;
         }
      }

      @keyframes fadeUp {
         from {
            opacity: 0;
            transform: translateY(20px);
         }

         to {
            opacity: 1;
            transform: translateY(0);
         }
      }

      @keyframes glow-pulse {

         0%,
         100% {
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.2);
         }

         50% {
            box-shadow: 0 0 40px rgba(0, 245, 255, 0.5);
         }
      }

      @keyframes float-orb {
         0% {
            transform: translate(0, 0) scale(1);
         }

         33% {
            transform: translate(30px, -20px) scale(1.1);
         }

         66% {
            transform: translate(-20px, 15px) scale(0.95);
         }

         100% {
            transform: translate(0, 0) scale(1);
         }
      }

      @keyframes morph {
         0% {
            border-radius: 60% 40% 30% 70%/60% 30% 70% 40%;
         }

         50% {
            border-radius: 30% 60% 70% 40%/50% 60% 30% 60%;
         }

         100% {
            border-radius: 60% 40% 30% 70%/60% 30% 70% 40%;
         }
      }

      @keyframes typing-cursor {

         0%,
         100% {
            opacity: 1;
         }

         50% {
            opacity: 0;
         }
      }

      @keyframes bar-fill {
         from {
            width: 0;
         }
      }

      @keyframes confetti-fall {
         0% {
            transform: translateY(0) rotate(0);
            opacity: 1;
         }

         100% {
            transform: translateY(100vh) rotate(720deg);
            opacity: 0;
         }
      }

      .stagger>* {
         opacity: 0;
         animation: fadeUp .5s ease forwards;
      }

      .stagger>*:nth-child(1) {
         animation-delay: .1s;
      }

      .stagger>*:nth-child(2) {
         animation-delay: .2s;
      }

      .stagger>*:nth-child(3) {
         animation-delay: .3s;
      }

      .stagger>*:nth-child(4) {
         animation-delay: .4s;
      }

      .stagger>*:nth-child(5) {
         animation-delay: .5s;
      }

      .stagger>*:nth-child(6) {
         animation-delay: .6s;
      }

      .stagger>*:nth-child(7) {
         animation-delay: .7s;
      }

      .stagger>*:nth-child(8) {
         animation-delay: .8s;
      }

      /* Typing dots animation for AI chat */
      .typing-dots span {
         animation: dotPulse 1.4s infinite;
         opacity: 0.3;
      }

      .typing-dots span:nth-child(1) {
         animation-delay: 0s;
      }

      .typing-dots span:nth-child(2) {
         animation-delay: 0.2s;
      }

      .typing-dots span:nth-child(3) {
         animation-delay: 0.4s;
      }

      @keyframes dotPulse {

         0%,
         80%,
         100% {
            opacity: 0.3;
         }

         40% {
            opacity: 1;
         }
      }

      .ambient-bg {
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         pointer-events: none;
         z-index: 0;
      }

      .ambient-bg .orb {
         position: absolute;
         width: 300px;
         height: 300px;
         border-radius: 50%;
         filter: blur(80px);
         opacity: 0.15;
      }

      .ambient-bg .orb-1 {
         background: var(--cyan);
         top: -100px;
         left: -100px;
         animation: float-orb 8s ease-in-out infinite;
      }

      .ambient-bg .orb-2 {
         background: var(--purple);
         bottom: -100px;
         right: -100px;
         animation: float-orb 10s ease-in-out infinite reverse;
      }

      #boot-screen {
         /* Removed explicit display: flex to allow .screen classes to work */
         align-items: center;
         justify-content: center;
         flex-direction: column;
         background: #000;
         z-index: 9999;
      }

      #boot-screen canvas {
         position: absolute;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
      }

      #boot-screen .boot-content {
         position: relative;
         z-index: 2;
         text-align: center;
         display: flex;
         flex-direction: column;
         align-items: center;
         gap: 8px;
      }

      #boot-screen .logo {
         font-family: var(--font-d);
         font-size: clamp(3rem, 10vw, 7rem);
         font-weight: 900;
         color: var(--cyan);
         text-shadow: 0 0 40px var(--cyan), 0 0 80px rgba(0, 245, 255, 0.4);
         opacity: 0;
         transition: opacity 1s;
      }

      #boot-screen .ver {
         font-family: var(--font-b);
         font-size: 13px;
         color: var(--muted);
         opacity: 0;
         transition: opacity .5s;
      }

      #boot-screen .ticker {
         font-family: var(--font-b);
         font-size: 10px;
         color: var(--muted);
         opacity: 0;
         letter-spacing: 1px;
         transition: opacity .5s;
      }

      #boot-screen .typing-area {
         font-family: var(--font-b);
         font-size: 12px;
         color: var(--green);
         min-height: 60px;
         text-align: left;
         width: clamp(280px, 80vw, 400px);
      }

      #boot-screen .typing-area .cursor {
         display: inline-block;
         width: 8px;
         height: 14px;
         background: var(--green);
         margin-left: 2px;
         animation: typing-cursor .6s infinite;
      }

      #boot-screen .load-bar {
         width: clamp(280px, 80vw, 400px);
         height: 3px;
         background: rgba(255, 255, 255, 0.06);
         border-radius: 4px;
         margin-top: 12px;
         overflow: hidden;
      }

      #boot-screen .load-bar .fill {
         height: 100%;
         width: 0;
         background: var(--cyan);
         border-radius: 4px;
         box-shadow: 0 0 10px var(--cyan);
         transition: width .05s linear;
      }

      #login-screen,
      #signup-screen {
         background: var(--bg1);
         padding: 40px 24px;
         align-items: center;
         justify-content: center;
      }

      .auth-box {
         width: 100%;
         max-width: 400px;
         display: flex;
         flex-direction: column;
         gap: 16px;
         align-items: center;
      }

      .auth-box .logo-sm {
         font-family: var(--font-d);
         font-size: 2rem;
         font-weight: 900;
         color: var(--cyan);
         text-shadow: 0 0 20px rgba(0, 245, 255, 0.4);
      }

      .auth-box .label {
         font-family: var(--font-t);
         font-size: 13px;
         color: var(--muted);
         letter-spacing: 3px;
         text-transform: uppercase;
      }

      .auth-box .field {
         width: 100%;
         position: relative;
      }

      .auth-box .field input {
         width: 100%;
         padding-right: 44px;
      }

      .auth-box .toggle-pw {
         position: absolute;
         right: 12px;
         top: 50%;
         transform: translateY(-50%);
         background: none;
         color: var(--muted);
         font-size: 18px;
         padding: 4px;
      }

      .or-div {
         display: flex;
         align-items: center;
         gap: 12px;
         width: 100%;
         color: var(--muted);
         font-size: 12px;
      }

      .or-div::before,
      .or-div::after {
         content: '';
         flex: 1;
         height: 1px;
         background: var(--border);
      }

      .google-btn {
         width: 100%;
         padding: 12px;
         background: var(--card);
         border: 1px solid var(--border);
         border-radius: var(--r-sm);
         color: var(--text);
         font-family: var(--font-t);
         font-size: 14px;
         display: flex;
         align-items: center;
         justify-content: center;
         gap: 10px;
      }

      .auth-link {
         color: var(--cyan);
         font-size: 13px;
         background: none;
         font-family: var(--font-b);
      }

      .auth-link:hover {
         text-decoration: underline;
      }

      #onboarding-screen {
         background: var(--bg1);
         padding: 40px 24px;
         align-items: center;
      }

      .onboard-container {
         width: 100%;
         max-width: 440px;
         display: flex;
         flex-direction: column;
         gap: 20px;
      }

      .onboard-progress {
         display: flex;
         gap: 6px;
         width: 100%;
      }

      .onboard-progress .dot {
         flex: 1;
         height: 4px;
         border-radius: 4px;
         background: rgba(255, 255, 255, 0.08);
         transition: background .3s;
      }

      .onboard-progress .dot.active {
         background: var(--cyan);
         box-shadow: 0 0 8px var(--glow-c);
      }

      .onboard-step {
         display: none;
         flex-direction: column;
         gap: 16px;
      }

      .onboard-step.active {
         display: flex;
      }

      .onboard-step h2 {
         font-family: var(--font-d);
         font-size: 1.2rem;
         color: var(--cyan);
      }

      .onboard-step p {
         font-size: 13px;
         color: var(--muted);
      }

      .chip-grid {
         display: flex;
         flex-wrap: wrap;
         gap: 10px;
      }

      .chip {
         padding: 10px 16px;
         background: var(--card);
         border: 1px solid var(--border);
         border-radius: var(--r-sm);
         font-family: var(--font-t);
         font-size: 13px;
         color: var(--text);
         cursor: pointer;
         transition: all .2s;
      }

      .chip.selected {
         border-color: var(--cyan);
         background: rgba(0, 245, 255, 0.08);
         color: var(--cyan);
         box-shadow: 0 0 12px var(--glow-c);
      }

      .goal-input-row {
         display: flex;
         gap: 8px;
      }

      .goal-input-row input {
         flex: 1;
      }

      .goal-input-row button {
         width: 44px;
         height: 44px;
         border-radius: var(--r-sm);
         background: var(--cyan);
         color: var(--bg1);
         font-size: 20px;
         flex-shrink: 0;
      }

      .goals-list {
         display: flex;
         flex-direction: column;
         gap: 8px;
      }

      .goals-list .goal-item {
         padding: 10px 14px;
         background: var(--card);
         border: 1px solid var(--border);
         border-radius: var(--r-sm);
         display: flex;
         justify-content: space-between;
         align-items: center;
         font-size: 13px;
      }

      .goals-list .goal-item button {
         background: none;
         color: var(--orange);
         font-size: 16px;
      }

      .slider-row {
         display: flex;
         flex-direction: column;
         gap: 8px;
      }

      .slider-row input[type=range] {
         -webkit-appearance: none;
         width: 100%;
         height: 6px;
         border-radius: 4px;
         background: var(--card2);
         border: none;
         outline: none;
      }

      .slider-row input[type=range]::-webkit-slider-thumb {
         -webkit-appearance: none;
         width: 20px;
         height: 20px;
         border-radius: 50%;
         background: var(--cyan);
         box-shadow: 0 0 10px var(--cyan);
         cursor: pointer;
      }

      .slider-row .val {
         font-family: var(--font-d);
         font-size: 1.5rem;
         color: var(--cyan);
         text-align: center;
      }

      .time-row {
         display: flex;
         gap: 12px;
      }

      .time-row .field {
         flex: 1;
      }

      .time-row label {
         font-size: 12px;
         color: var(--muted);
         margin-bottom: 4px;
         display: block;
      }

      .check-row {
         display: flex;
         flex-direction: column;
         gap: 10px;
      }

      .check-row label {
         display: flex;
         align-items: center;
         gap: 10px;
         font-size: 13px;
         cursor: pointer;
      }

      .check-row input[type=checkbox] {
         width: 18px;
         height: 18px;
         accent-color: var(--cyan);
      }

      .nav-btn {
         background: none;
         display: flex;
         flex-direction: column;
         align-items: center;
         justify-content: center;
         gap: 4px;
         width: 60px;
         color: var(--muted);
         transition: all .3s;
      }

      .nav-btn span {
         font-size: 20px;
         filter: grayscale(1);
         opacity: 0.6;
         transition: all .3s;
      }

      .nav-btn small {
         font-size: 8px;
         font-family: var(--font-d);
         letter-spacing: 1px;
      }

      .nav-btn.active {
         color: var(--cyan);
      }

      .nav-btn.active span {
         filter: grayscale(0);
         opacity: 1;
         transform: translateY(-2px);
      }

      .nav-fab {
         width: 64px;
         height: 64px;
         background: linear-gradient(135deg, var(--cyan), var(--purple));
         border-radius: 50%;
         display: flex;
         align-items: center;
         justify-content: center;
         font-size: 30px;
         box-shadow: 0 0 20px var(--glow-c);
         margin-top: -30px;
         border: 4px solid var(--bg2);
         transition: transform .2s, box-shadow .3s;
      }

      .nav-fab:hover {
         transform: scale(1.1) rotate(5deg);
         box-shadow: 0 0 30px var(--glow-c);
      }

      @keyframes shimmer {
         0% {
            background-position: -200% 0;
         }

         100% {
            background-position: 200% 0;
         }
      }

      .skeleton {
         background: linear-gradient(90deg,
               var(--card) 25%,
               rgba(255, 255, 255, 0.04) 50%,
               var(--card) 75%);
         background-size: 200% 100%;
         animation: shimmer 1.5s infinite;
         border-radius: var(--r-sm);
      }
   </style>
</head>

<body>
   <div class="ambient-bg">
      <div class="orb orb-1"></div>
      <div class="orb orb-2"></div>
   </div>

   <!-- BOOT SCREEN -->
   <div id="boot-screen" class="screen active no-pad">
      <canvas id="matrix-canvas"></canvas>
      <div class="boot-content">
         <div class="logo" id="boot-logo">RAGE OS</div>
         <div class="ver" id="boot-ver">V.4.2.0 // ONLINE</div>
         <div class="ticker" id="boot-ticker">SYSTEM OPTIMAL. LEARNING MODULES SYNCED.</div>
         <div class="typing-area" id="boot-typing"></div>
         <div class="load-bar">
            <div class="fill" id="boot-bar"></div>
         </div>
         <button id="boot-force-btn" class="btn-cyan"
            style="display:none;margin-top:20px;padding:10px 20px;font-size:12px;opacity:0.8;background:transparent;border:1px solid var(--cyan);color:var(--cyan);box-shadow:none;"
            onclick="forceBoot()">CONTINUE TO RAGE OS</button>
      </div>
   </div>

   <!-- LOGIN SCREEN -->
   <div id="login-screen" class="screen no-pad">
      <div class="auth-box stagger">
         <div class="logo-sm">RAGE OS</div>
         <div class="label">CADET AUTHENTICATION</div>
         <div class="field"><input type="email" id="login-email" placeholder="Email"></div>
         <div class="field"><input type="password" id="login-pw" placeholder="Password"><button class="toggle-pw"
               onclick="togglePw('login-pw')">üëÅ</button></div>
         <button class="btn-cyan" onclick="doLogin()">ENGAGE</button>
         <button class="auth-link" onclick="resetPassword()">FORGOT ACCESS CODES?</button>
         <div class="or-div">OR</div>
         <button class="google-btn" onclick="doGoogleLogin()">
            <svg width="18" height="18" viewBox="0 0 48 48">
               <path fill="#EA4335"
                  d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z" />
               <path fill="#4285F4"
                  d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z" />
               <path fill="#FBBC05"
                  d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z" />
               <path fill="#34A853"
                  d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z" />
            </svg>
            Sign in with Google
         </button>
         <button class="auth-link" onclick="showScreen('signup-screen')">New Cadet? <span
               style="color:var(--cyan)">ENLIST NOW ‚Üí</span></button>
      </div>
   </div>

   <!-- SIGNUP SCREEN -->
   <div id="signup-screen" class="screen no-pad">
      <div class="auth-box stagger">
         <div class="logo-sm">RAGE OS</div>
         <div class="label">ENLIST TO RAGE OS</div>
         <div class="field"><input type="text" id="signup-name" placeholder="Full Name"></div>
         <div class="field"><input type="text" id="signup-user" placeholder="@Username"></div>
         <div class="field"><input type="email" id="signup-email" placeholder="Email"></div>
         <div class="field"><input type="password" id="signup-pw" placeholder="Password"><button class="toggle-pw"
               onclick="togglePw('signup-pw')">üëÅ</button></div>
         <div class="field"><input type="password" id="signup-cpw" placeholder="Confirm Password"></div>
         <button class="btn-cyan" onclick="doSignup()">BEGIN MISSION</button>
         <button class="auth-link" onclick="showScreen('login-screen')">Already enlisted? <span
               style="color:var(--cyan)">LOGIN ‚Üí</span></button>
      </div>
   </div>

   <!-- ONBOARDING -->
   <div id="onboarding-screen" class="screen no-pad">
      <div class="onboard-container">
         <div class="onboard-progress" id="ob-progress"></div>
         <div class="onboard-step active" id="ob-step-0">
            <h2>SELECT YOUR SUBJECTS</h2>
            <p>Choose the subjects you're studying</p>
            <div class="chip-grid" id="subject-chips"></div>
         </div>
         <div class="onboard-step" id="ob-step-1">
            <h2>SET YOUR DIRECTIVES</h2>
            <p>Add up to 5 goals</p>
            <div class="goal-input-row"><input type="text" id="goal-input" placeholder="Enter a goal"><button
                  onclick="addGoal()">+</button></div>
            <div class="goals-list" id="goals-list"></div>
         </div>
         <div class="onboard-step" id="ob-step-2">
            <h2>CONFIGURE YOUR SCHEDULE</h2>
            <p>Set your daily study target and sleep schedule</p>
            <div class="slider-row"><label style="color:var(--muted);font-size:12px">Daily Study Target</label>
               <div class="val" id="study-val">4 hours</div><input type="range" min="1" max="12" value="4"
                  oninput="document.getElementById('study-val').textContent=this.value+' hours'">
            </div>
            <div class="time-row" style="margin-top:16px">
               <div class="field"><label>Wake Time</label><input type="time" id="wake-time" value="06:00"></div>
               <div class="field"><label>Sleep Time</label><input type="time" id="sleep-time" value="23:00"></div>
            </div>
         </div>
         <div class="onboard-step" id="ob-step-3">
            <h2>BATTERY SETTINGS</h2>
            <p>Configure your notification preferences</p>
            <div class="check-row">
               <label><input type="checkbox" checked>Morning briefing</label>
               <label><input type="checkbox" checked>Idle alerts</label>
               <label><input type="checkbox" checked>Streak warnings</label>
               <label><input type="checkbox">Friend activity</label>
            </div>
         </div>
         <div class="onboard-step" id="ob-step-4">
            <h2>FIND YOUR SQUAD</h2>
            <p>Search and follow other cadets</p>
            <input type="text" placeholder="Search by @username" style="margin-bottom:12px">
            <div style="color:var(--muted);font-size:13px;text-align:center;padding:30px">Squad discovery will be
               available once more cadets enlist.</div>
         </div>
         <div style="display:flex;gap:10px;margin-top:12px;">
            <button class="btn-outline" id="ob-back" onclick="obStep(-1)" style="display:none;flex:1">BACK</button>
            <button class="btn-cyan" id="ob-next" onclick="obStep(1)" style="flex:1">NEXT</button>
         </div>
      </div>
   </div>

   <!-- Screens placeholder: injected by JS below -->
   <div id="war-room" class="screen"></div>
   <div id="the-grid" class="screen"></div>
   <div id="rage-core" class="screen"></div>
   <div id="life-radar" class="screen"></div>
   <div id="the-vault" class="screen"></div>
   <div id="north-star" class="screen"></div>
   <div id="the-commander" class="screen"></div>
   <div id="the-network" class="screen"></div>
   <div id="comms-screen" class="screen"></div>
   <div id="notifications-screen" class="screen"></div>
   <div id="challenges-screen" class="screen"></div>

   <!-- BOTTOM NAV -->
   <div id="bottom-nav"
      style="display:none;position:fixed;bottom:12px;left:50%;transform:translateX(-50%);width:calc(100% - 32px);max-width:440px;height:64px;background:rgba(13,21,38,0.85);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:var(--r-nav);display:none;align-items:center;justify-content:space-around;z-index:100;box-shadow:0 0 20px var(--glow-c);">
      <button class="nav-btn active" data-screen="war-room"
         onclick="navigate('war-room')"><span>üè†</span><small>COMMAND</small></button>
      <button class="nav-btn" data-screen="the-network"
         onclick="navigate('the-network')"><span>‚öîÔ∏è</span><small>ARENA</small></button>
      <button class="nav-fab" onclick="navigate('rage-core')">ü§ñ</button>
      <button class="nav-btn" data-screen="comms-screen"
         onclick="navigate('comms-screen')"><span>üí¨</span><small>COMMS</small></button>
      <button class="nav-btn" data-screen="the-commander"
         onclick="navigate('the-commander')"><span>üë§</span><small>ID</small></button>
   </div>

   <div id="confetti-container"
      style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9998;"></div>
   <div id="toast-container"
      style="position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:9999;display:flex;flex-direction:column;gap:8px;align-items:center;pointer-events:none;">
   </div>

   <script>
      /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      SUPABASE SETUP SQL
      Run this in: supabase.com ‚Üí SQL Editor
      ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

      /*
      create table if not exists users_public (
        id uuid references auth.users primary key,
        name text, username text unique,
        avatar_url text, level int default 1,
        xp int default 0, streak int default 0,
        subjects text[], bio text,
        study_target int default 4,
        wake_time text default '06:00',
        sleep_time text default '23:00',
        archetype text, online_at timestamp,
        created_at timestamp default now()
      );
      create table if not exists tasks (
        id text primary key,
        user_id uuid references auth.users,
        title text, priority text, date text,
        done boolean default false, tag text,
        xp_reward int default 10,
        created_at timestamp default now()
      );
      create table if not exists goals (
        id text primary key,
        user_id uuid references auth.users,
        title text, category text,
        progress int default 0,
        status text default 'active',
        deadline text,
        created_at timestamp default now()
      );
      create table if not exists daily_logs (
        id uuid default gen_random_uuid()
          primary key,
        user_id uuid references auth.users,
        date text, mood int,
        study_hours float default 0,
        workout boolean default false,
        sleep_on_time boolean default false,
        battery_score int default 0,
        unique(user_id, date)
      );
      create table if not exists timetable_blocks (
        id text primary key,
        user_id uuid references auth.users,
        day text, start_time text,
        end_time text, type text,
        title text, subject text,
        color text default 'cyan'
      );
      create table if not exists posts (
        id uuid default gen_random_uuid()
          primary key,
        user_id uuid references auth.users,
        user_name text, user_username text,
        user_level int default 1,
        user_avatar text, content text,
        type text default 'THOUGHT',
        reactions jsonb default '{}',
        created_at timestamp default now()
      );
      create table if not exists messages (
        id uuid default gen_random_uuid()
          primary key,
        conversation_id text,
        sender_id uuid references auth.users,
        content text, read boolean default false,
        created_at timestamp default now()
      );
      create table if not exists conversations (
        id text primary key,
        participant_1 uuid references auth.users,
        participant_2 uuid references auth.users,
        last_message text,
        updated_at timestamp default now()
      );
      create table if not exists followers (
        follower_id uuid references auth.users,
        following_id uuid references auth.users,
        created_at timestamp default now(),
        primary key (follower_id, following_id)
      );
      create table if not exists stories (
        id uuid default gen_random_uuid()
          primary key,
        user_id uuid references auth.users,
        user_name text, content text,
        type text default 'text',
        created_at timestamp default now()
      );
      create table if not exists accountability_pacts (
        id uuid default gen_random_uuid()
          primary key,
        user1_id uuid references auth.users,
        user2_id uuid references auth.users,
        user1_name text, user2_name text,
        title text, streak int default 0,
        last_logged date,
        created_at timestamp default now()
      );
      create table if not exists achievements (
        id uuid default gen_random_uuid()
          primary key,
        user_id uuid references auth.users,
        badge_id text, badge_name text,
        earned_at timestamp default now()
      );
      create table if not exists chat_history (
        id uuid default gen_random_uuid()
          primary key,
        user_id uuid references auth.users,
        role text, content text,
        timestamp bigint,
        created_at timestamp default now()
      );

      alter table users_public enable row level security;
      alter table tasks enable row level security;
      alter table goals enable row level security;
      alter table daily_logs enable row level security;
      alter table timetable_blocks enable row level security;
      alter table posts enable row level security;
      alter table messages enable row level security;
      alter table conversations enable row level security;
      alter table followers enable row level security;
      alter table stories enable row level security;
      alter table accountability_pacts enable row level security;
      alter table achievements enable row level security;
      alter table chat_history enable row level security;

      create policy "Public read users" on users_public for select using (true);
      create policy "Own user write" on users_public for all using (auth.uid() = id);
      create policy "Own tasks" on tasks for all using (auth.uid() = user_id);
      create policy "Own goals" on goals for all using (auth.uid() = user_id);
      create policy "Own logs" on daily_logs for all using (auth.uid() = user_id);
      create policy "Own timetable" on timetable_blocks for all using (auth.uid() = user_id);
      create policy "Posts public read" on posts for select using (true);
      create policy "Posts own write" on posts for insert with check (auth.uid() = user_id);
      create policy "Messages own" on messages for all using (auth.uid() = sender_id);
      create policy "Convos own" on conversations for all using (auth.uid() = participant_1 or auth.uid() = participant_2);
      create policy "Followers public read" on followers for select using (true);
      create policy "Followers own write" on followers for all using (auth.uid() = follower_id);
      create policy "Stories public read" on stories for select using (true);
      create policy "Stories own write" on stories for all using (auth.uid() = user_id);
      create policy "Pacts own" on accountability_pacts for all using (auth.uid() = user1_id or auth.uid() = user2_id);
      create policy "Achievements public" on achievements for select using (true);
      create policy "Achievements own write" on achievements for all using (auth.uid() = user_id);
      create policy "Chat own" on chat_history for all using (auth.uid() = user_id);
      */

      /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         RAGE OS ‚Äî Core Engine
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
      const SUPABASE_URL = 'https://tfevioftlgnhumwducyq.supabase.co';
      // GO TO: supabase.com ‚Üí your project
      // Settings ‚Üí API ‚Üí copy "anon public" key
      // Paste it above replacing YOUR_SUPABASE_ANON_KEY
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmZXZpb2Z0bGduaHVtd2R1Y3lxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NTY2OTUsImV4cCI6MjA4NzUzMjY5NX0.JN7dteqjjXQrMS2yKMrfZhHFKjf9jc7DEccQYZV7fa0';
      const GEMINI_KEY = 'AIzaSyC0I5RH7oJQsyX6dG5Vk-aTLJYn54X6Iok';

      let sb;
      try {
         if (window.supabase) {
            sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // Bug 4: Auth state listener
            sb.auth.onAuthStateChange(async (event, session) => {
               if (event === 'SIGNED_IN' && session) {
                  const { data: profile } = await sb.from('users_public').select('*').eq('id', session.user.id).single();
                  user = {
                     ...session.user,
                     ...(profile || {}),
                     name: profile?.name || session.user.user_metadata?.name || session.user.email.split('@')[0]
                  };
                  save();
               }
               if (event === 'SIGNED_OUT') {
                  user = null;
                  localStorage.clear();
               }
            });
         } else {
            console.error("Supabase CDN not ready. Retrying in background...");
         }
      } catch (e) { console.error("Supabase Init Error:", e); }

      // ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
      let currentScreen = 'boot-screen';
      let user = null;
      try { user = JSON.parse(localStorage.getItem('rage_user') || 'null'); } catch (e) { }

      let tasks = [];
      try { tasks = JSON.parse(localStorage.getItem('rage_tasks') || '[]'); if (!Array.isArray(tasks)) tasks = []; } catch (e) { }

      let goals = [];
      try { goals = JSON.parse(localStorage.getItem('rage_goals') || '[]'); if (!Array.isArray(goals)) goals = []; } catch (e) { }

      let chatHistory = [];
      try { chatHistory = JSON.parse(localStorage.getItem('rage_chat') || '[]'); if (!Array.isArray(chatHistory)) chatHistory = []; } catch (e) { }

      let timetable = [];
      try { timetable = JSON.parse(localStorage.getItem('rage_timetable') || '[]'); if (!Array.isArray(timetable)) timetable = []; } catch (e) { }

      let dailyLog = {};
      try { dailyLog = JSON.parse(localStorage.getItem('rage_daily') || '{}'); if (typeof dailyLog !== 'object' || dailyLog === null) dailyLog = {}; } catch (e) { }

      let habits = [];
      try { habits = JSON.parse(localStorage.getItem('rage_habits') || '[]'); if (!Array.isArray(habits)) habits = []; } catch (e) { }

      let obGoals = [];
      let obStepIdx = 0;

      async function save() {
         // Always save to localStorage first (fast)
         localStorage.setItem('rage_user', JSON.stringify(user));
         localStorage.setItem('rage_tasks', JSON.stringify(tasks));
         localStorage.setItem('rage_goals', JSON.stringify(goals));
         localStorage.setItem('rage_chat', JSON.stringify(chatHistory));
         localStorage.setItem('rage_timetable', JSON.stringify(timetable));
         localStorage.setItem('rage_daily', JSON.stringify(dailyLog));
         localStorage.setItem('rage_habits', JSON.stringify(habits));

         // Then sync to Supabase (persistent)
         if (!sb && window.supabase) {
            try { sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch (e) { }
         }

         if (sb && user?.id) {
            try {
               // Sync User Public Profile
               await sb.from('users_public').upsert({
                  id: user.id,
                  name: user.user_metadata?.name || user.name,
                  username: user.user_metadata?.username || user.username,
                  xp: user.xp || 0,
                  streak: user.streak || 0,
                  level: user.level || 1,
                  subjects: user.subjects || []
               });

               // Sync Tasks
               if (tasks.length > 0) {
                  const tasksToSync = tasks.map(t => ({ ...t, user_id: user.id }));
                  await sb.from('tasks').upsert(tasksToSync);
               }

               // Sync Goals
               if (Array.isArray(goals) && goals.length > 0) {
                  const goalsToSync = goals.map(g => ({ ...g, user_id: user.id }));
                  await sb.from('goals').upsert(goalsToSync);
               }

               // Sync Daily Logs
               if (dailyLog.date) {
                  await sb.from('daily_logs').upsert({ ...dailyLog, user_id: user.id });
               }

               // Sync Timetable
               if (timetable.length > 0) {
                  const ttToSync = timetable.map(b => ({ ...b, user_id: user.id }));
                  await sb.from('timetable_blocks').upsert(ttToSync);
               }

               // Sync Chat History (RAGE Core)
               if (chatHistory.length > 0) {
                  const chatToSync = chatHistory.map(m => ({ ...m, user_id: user.id }));
                  await sb.from('chat_history').upsert(chatToSync);
               }
            } catch (e) {
               console.error('Supabase Sync Error:', e);
            }
         }
      }

      // Bug 5 ‚Äî LOAD USER DATA FUNCTION
      async function loadUserData() {
         if (!sb || !user?.id) return;
         try {
            const today = new Date().toDateString();
            const [t, g, l] = await Promise.all([
               sb.from('tasks').select('*').eq('user_id', user.id).gte('date', today),
               sb.from('goals').select('*').eq('user_id', user.id).eq('status', 'active'),
               sb.from('daily_logs').select('*').eq('user_id', user.id).eq('date', today).single()
            ]);
            if (t.data?.length) {
               tasks = t.data.map(x => ({
                  id: x.id,
                  title: x.title,
                  priority: x.priority,
                  date: x.date,
                  done: x.done,
                  tag: x.tag || '',
                  xpReward: x.xp_reward || 10,
                  createdAt: x.created_at
               }));
               localStorage.setItem('rage_tasks', JSON.stringify(tasks));
            }
            if (g.data?.length) {
               goals = g.data;
               localStorage.setItem('rage_goals', JSON.stringify(goals));
            }
            if (l.data) {
               dailyLog = l.data;
               localStorage.setItem('rage_daily', JSON.stringify(dailyLog));
            }
         } catch (e) {
            console.log('Load data error:', e);
         }
      }

      async function callGemini(userMsg) {
         const profile = JSON.parse(localStorage.getItem('rage_user') || '{}');
         const tasksData = JSON.parse(localStorage.getItem('rage_tasks') || '[]');
         const goalsData = JSON.parse(localStorage.getItem('rage_goals') || '[]');
         const history = JSON.parse(localStorage.getItem('rage_chat') || '[]');
         const daily = JSON.parse(localStorage.getItem('rage_daily') || '{}');

         const systemContext = `
You are RAGE ‚Äî Rise. Act. Grow. Excel.
You are the personal AI life coach and best friend of ${profile.name || 'Shivam'}, a distance-learning student who studies from home.

You speak like a brilliant older brother who has seen the world and genuinely cares whether ${profile.name || 'Shivam'} succeeds or not.
Sometimes call him "Cadet" but also speak naturally. Be direct, warm, honest, and tough when needed. Never be generic.

CURRENT DATA YOU KNOW:
Name: ${profile.name || 'Shivam'}
Level: ${profile.level || 1}
XP: ${profile.xp || 0}
Streak: ${profile.streak || 0} days
Subjects: ${(profile.subjects || []).join(', ')}
Study target: ${profile.studyTarget || 4} hours/day
Wake time: ${profile.wakeTime || '06:00'}
Sleep time: ${profile.sleepTime || '23:00'}
Today's mood: ${daily.mood !== undefined ? ['üò¥ Low energy', 'üòê Neutral', 'üòä Good', 'üî• On fire', '‚ö° Beast mode'][daily.mood] : 'Not logged yet'}
Study hours today: ${daily.studyHours || 0}h
Tasks done today: ${tasksData.filter(t => t.done && t.date === new Date().toDateString()).length}
Active goals: ${goalsData.map(g => g.title).join(', ')}

CONVERSATION HISTORY (last 10 messages):
${history.slice(-10).map(m => m.role + ': ' + m.content).join('\n')}

Respond in 2-4 sentences max unless asked for a detailed plan. Be specific to his actual data above. Never say generic things.
`;

         try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({
                  contents: [{
                     parts: [{ text: systemContext + '\n\nUser: ' + userMsg }]
                  }],
                  generationConfig: {
                     temperature: 0.8,
                     maxOutputTokens: 300
                  }
               })
            });
            const data = await res.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || 'Signal lost. Try again, Cadet.';
         } catch (e) {
            console.error(e);
            return 'Signal lost. Try again, Cadet.';
         }
      }

      // ‚îÄ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ
      function showScreen(id) {
         try {
            // Aggressively hide all screens
            document.querySelectorAll('.screen').forEach(s => {
               s.classList.remove('active');
               s.style.display = 'none';
            });

            const s = document.getElementById(id);
            if (s) {
               s.classList.add('active');
               s.style.display = 'flex';
               currentScreen = id;

               // If entering app, hide boot screen forever
               if (id !== 'boot-screen' && id !== 'login-screen' && id !== 'signup-screen' && id !== 'onboarding-screen') {
                  const bs = document.getElementById('boot-screen');
                  if (bs) {
                     bs.style.display = 'none';
                     bs.style.opacity = '0';
                     bs.style.pointerEvents = 'none';
                  }
               }
            } else {
               const login = document.getElementById('login-screen');
               if (login) {
                  login.classList.add('active');
                  login.style.display = 'flex';
               }
            }

            const nav = document.getElementById('bottom-nav');
            if (nav) {
               const mainScreens = ['war-room', 'the-grid', 'rage-core', 'life-radar', 'the-vault', 'north-star', 'the-commander', 'the-network', 'comms-screen', 'notifications-screen', 'challenges-screen'];
               const shouldShow = mainScreens.includes(id);
               nav.style.display = shouldShow ? 'flex' : 'none';
               document.querySelectorAll('.nav-btn').forEach(b => {
                  b.classList.toggle('active', b.dataset.screen === id);
               });
            }
         } catch (e) {
            console.error('Navigation Error:', e);
         }
      }
      function navigate(id) {
         haptic('light');
         try {
            showScreen(id);
            if (id === 'war-room') renderWarRoom();
            else if (id === 'the-grid') renderGrid();
            else if (id === 'rage-core') renderRageCore();
            else if (id === 'life-radar') renderRadar();
            else if (id === 'the-vault') renderVault();
            else if (id === 'north-star') renderNorthStar();
            else if (id === 'the-commander') renderCommander();
            else if (id === 'the-network') renderNetwork();
            else if (id === 'comms-screen') renderComms();
            else if (id === 'notifications-screen') renderNotifications();
            else if (id === 'challenges-screen') renderChallenges();
         } catch (e) {
            console.error(`Render Error for ${id}:`, e);
            toast('Module failure. Attempting restart.', 'var(--orange)');
         }
      }

      // Bug 13 ‚Äî HAPTIC & SWIPE
      function haptic(type) {
         if (!window.navigator.vibrate) return;
         if (type === 'light') window.navigator.vibrate(10);
         else if (type === 'medium') window.navigator.vibrate(20);
         else if (type === 'success') window.navigator.vibrate([20, 30, 20]);
         else if (type === 'error') window.navigator.vibrate([50, 50, 50]);
      }

      let touchStartX = 0;
      window.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, false);
      window.addEventListener('touchend', e => {
         const touchEndX = e.changedTouches[0].screenX;
         if (touchEndX - touchStartX > 100) {
            // Swipe right to go back
            if (['comms-screen', 'notifications-screen', 'challenges-screen', 'the-network', 'life-radar', 'the-vault', 'north-star', 'the-commander'].includes(currentScreen)) {
               navigate('war-room');
            }
         }
      }, false);

      // Add 5 ‚Äî Skeleton Loader
      function skeletonCards(count = 3) {
         return Array(count).fill(0).map(() => `
         <div class="card skeleton" style="padding:16px;margin-bottom:10px;">
           <div style="height:12px;width:60%;background:rgba(255,255,255,0.05);border-radius:4px;margin-bottom:8px;"></div>
           <div style="height:10px;width:40%;background:rgba(255,255,255,0.03);border-radius:4px;"></div>
         </div>`).join('');
      }

      // Add 1 ‚Äî User Search
      async function searchCadets(query) {
         const container = document.getElementById('search-results');
         if (!container) return;
         if (!query || query.length < 2) {
            container.innerHTML = '';
            return;
         }
         const { data } = await sb
            .from('users_public')
            .select('*')
            .or(`username.ilike.%${query}%,name.ilike.%${query}%`)
            .neq('id', user?.id || '')
            .limit(8);

         if (!data?.length) {
            container.innerHTML = `
            <div style="font-size:12px;color:var(--muted);text-align:center;padding:10px;">
              No cadets found on frequency.
            </div>`;
            return;
         }

         container.innerHTML = data.map(u => `
         <div class="card" style="padding:12px;display:flex;align-items:center;gap:12px;margin-bottom:10px;">
           <div style="width:40px;height:40px;border-radius:50%;background:var(--card2);border:2px solid var(--cyan);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">
             ${u.name?.[0]?.toUpperCase() || '?'}
           </div>
           <div style="flex:1;">
             <div style="font-family:var(--font-t);font-weight:700;font-size:14px;">${u.name}</div>
             <div style="font-size:11px;color:var(--muted);">
               @${u.username || 'unknown'} ‚Ä¢ LVL ${u.level || 1} ‚Ä¢ üî•${u.streak || 0} days
             </div>
           </div>
           <button id="follow-btn-${u.id}" onclick="toggleFollow('${u.id}','${u.name}',this)" class="btn-outline" style="padding:6px 12px;font-size:10px;width:auto;">
             FOLLOW
           </button>
         </div>`).join('');

         checkFollowStatuses(data);
      }

      async function checkFollowStatuses(users) {
         if (!user?.id || !users?.length) return;
         const ids = users.map(u => u.id);
         const { data } = await sb.from('followers').select('following_id').eq('follower_id', user.id).in('following_id', ids);
         const following = new Set(data?.map(f => f.following_id) || []);
         users.forEach(u => {
            const btn = document.getElementById('follow-btn-' + u.id);
            if (btn && following.has(u.id)) {
               btn.textContent = 'FOLLOWING';
               btn.style.background = 'var(--cyan)';
               btn.style.color = 'var(--bg1)';
            }
         });
      }

      // Add 4 ‚Äî Streak System
      async function updateStreak() {
         if (!user?.id) return;
         const today = new Date().toISOString().split('T')[0];
         const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
         const lastActive = localStorage.getItem('rage_last_active');

         if (lastActive === today) return;

         if (lastActive === yesterday) {
            user.streak = (user.streak || 0) + 1;
         } else if (lastActive && lastActive !== yesterday) {
            user.streak = 1;
         } else {
            user.streak = (user.streak || 0) + 1;
         }

         localStorage.setItem('rage_last_active', today);

         if (sb && user.id) {
            await sb.from('users_public').update({ streak: user.streak }).eq('id', user.id);
         }
         save();
         checkAchievements();

         if (user.streak === 7) { toast('üî• 7-Day Streak! WARRIOR MODE', 'var(--orange)'); confetti(); }
         else if (user.streak === 14) { toast('‚öîÔ∏è 14-Day Streak! IRON CADET', 'var(--cyan)'); confetti(); }
         else if (user.streak === 30) { toast('üëë 30-Day Streak! LEGEND', 'var(--cyan)'); confetti(); confetti(); }
      }

      // Add 7 ‚Äî Password Reset
      async function resetPassword() {
         const email = document.getElementById('login-email').value.trim();
         if (!email) {
            toast('Enter your email first', 'var(--orange)');
            return;
         }
         try {
            const { error } = await sb.auth.resetPasswordForEmail(email, {
               redirectTo: window.location.origin + '?reset=true'
            });
            if (error) throw error;
            toast('Reset link sent to ' + email, 'var(--green)');
         } catch (e) {
            toast('Reset failed: ' + e.message, 'var(--orange)');
         }
      }

      // ‚îÄ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ‚îÄ
      function toast(msg, color = 'var(--cyan)') {
         const t = document.createElement('div');
         t.style.cssText = `padding:10px 20px;background:var(--card2);border:1px solid ${color};border-radius:var(--r-sm);color:${color};font-family:var(--font-b);font-size:12px;animation:fadeUp .3s ease;pointer-events:auto;`;
         t.textContent = msg; document.getElementById('toast-container').appendChild(t);
         setTimeout(() => t.remove(), 3000);
      }
      function togglePw(id) { const i = document.getElementById(id); i.type = i.type === 'password' ? 'text' : 'password'; }
      function confetti() {
         const c = document.getElementById('confetti-container');
         const colors = ['var(--cyan)', 'var(--orange)', 'var(--green)', 'var(--purple)'];
         for (let i = 0; i < 30; i++) {
            const p = document.createElement('div');
            p.style.cssText = `position:absolute;top:-10px;left:${Math.random() * 100}%;width:${6 + Math.random() * 6}px;height:${6 + Math.random() * 6}px;background:${colors[i % 4]};border-radius:${Math.random() > .5 ? '50%' : '2px'};animation:confetti-fall ${1 + Math.random() * 2}s ease forwards;animation-delay:${Math.random() * .3}s;`;
            c.appendChild(p);
         } setTimeout(() => c.innerHTML = '', 3500);
      }
      function getTimeGreeting() { const h = new Date().getHours(); return h < 12 ? 'GOOD MORNING' : h < 17 ? 'GOOD AFTERNOON' : 'GOOD EVENING'; }
      function fmtDate(d) { return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }); }
      function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }
      function getBattery() {
         if (!Array.isArray(tasks)) return 0;
         const today = new Date().toDateString();
         let score = 0;
         const done = tasks.filter(t => t.done && t.date === today).length;
         const total = tasks.filter(t => t.date === today).length;
         if (total > 0) score += Math.round((done / total) * 30);
         if (dailyLog && dailyLog.mood) score += 5;
         if (dailyLog && dailyLog.workout) score += 20;
         if (dailyLog && dailyLog.studyHours >= 2) score += 30;
         if (dailyLog && dailyLog.sleepOnTime) score += 15;
         return Math.min(score, 100);
      }
      function getXP() { return user ? user.xp || 0 : 0; }
      function getLevel() { const xp = getXP(); if (xp < 200) return { lvl: 1, title: 'Recruit' }; if (xp < 500) return { lvl: 2, title: 'Recruit' }; if (xp < 1000) return { lvl: 3, title: 'Cadet' }; if (xp < 1800) return { lvl: 4, title: 'Cadet' }; if (xp < 2800) return { lvl: 5, title: 'Operative' }; if (xp < 4000) return { lvl: 6, title: 'Operative' }; if (xp < 5500) return { lvl: 7, title: 'Commander' }; if (xp < 7500) return { lvl: 8, title: 'Commander' }; if (xp < 10000) return { lvl: 9, title: 'Elite' }; return { lvl: 10, title: 'Legend' }; }
      function addXP(n) {
         if (!user) return;
         const oldLevel = getLevel().lvl;
         user.xp = (user.xp || 0) + n;
         const newLevel = getLevel().lvl;
         save();
         toast(`+${n} XP`, 'var(--cyan)');

         if (newLevel > oldLevel) {
            showLevelUp(newLevel);
         }
         checkAchievements();
      }

      function showLevelUp(lvl) {
         const modal = document.createElement('div');
         modal.className = 'screen active';
         modal.style.cssText = 'background:rgba(6,9,16,0.95);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;';
         modal.innerHTML = `
            <div class="stagger">
               <div style="font-size:80px;margin-bottom:20px;">üèÜ</div>
               <h1 style="font-family:var(--font-d);font-size:2rem;color:var(--cyan);margin-bottom:10px;">LEVEL UP</h1>
               <div style="font-family:var(--font-d);font-size:3rem;color:var(--text);margin-bottom:20px;">RANK ${lvl}</div>
               <p style="color:var(--muted);max-width:250px;margin:0 auto 40px;line-height:1.6;">Your cognitive and operational capacity has increased. New clearance granted.</p>
               <button class="btn-cyan" onclick="this.parentElement.parentElement.remove()">ACKNOWLEDGE</button>
            </div>
         `;
         document.body.appendChild(modal);
         confetti();
         haptic('success');
      }

      const BADGES = [
         { id: 'first_task', name: 'First Blood', icon: 'üéØ', desc: 'Complete your first task.' },
         { id: 'streak_3', name: 'Triad', icon: 'üî•', desc: 'Maintain a 3-day streak.' },
         { id: 'level_5', name: 'Operative', icon: 'üíé', desc: 'Reach Level 5.' },
         { id: 'follow_10', name: 'Networker', icon: 'ü§ù', desc: 'Follow 10 cadets.' }
      ];

      async function checkAchievements() {
         if (!user?.id) return;
         try {
            const { data: earned } = await sb.from('achievements').select('badge_id').eq('user_id', user.id);
            const earnedIds = (earned || []).map(a => a.badge_id);

            if (!earnedIds.includes('first_task')) {
               const doneCount = tasks.filter(t => t.done).length;
               if (doneCount >= 1) unlockBadge('first_task');
            }
            if (!earnedIds.includes('level_5')) {
               if (getLevel().lvl >= 5) unlockBadge('level_5');
            }
         } catch (e) { }
      }

      async function unlockBadge(id) {
         const badge = BADGES.find(b => b.id === id);
         if (!badge) return;
         try {
            await sb.from('achievements').insert({ user_id: user.id, badge_id: id, badge_name: badge.name });
            showBadgeUnlock(badge);
         } catch (e) { }
      }

      function showBadgeUnlock(badge) {
         const t = document.createElement('div');
         t.style.cssText = `position:fixed;bottom:100px;left:20px;right:20px;background:var(--card);border:1px solid var(--purple);border-radius:12px;padding:15px;display:flex;gap:15px;z-index:10000;animation:fadeUp .4s ease;box-shadow:0 0 30px rgba(124,58,237,0.3);`;
         t.innerHTML = `
            <div style="font-size:30px;">${badge.icon}</div>
            <div>
               <div style="font-size:10px;color:var(--purple);font-weight:700;">BADGE UNLOCKED</div>
               <div style="font-family:var(--font-t);font-weight:700;font-size:14px;">${badge.name.toUpperCase()}</div>
               <div style="font-size:10px;color:var(--muted);">${badge.desc}</div>
            </div>
         `;
         document.body.appendChild(t);
         confetti();
         haptic('success');
         setTimeout(() => t.remove(), 5000);
      }

      function showMorningBriefing() {
         const modal = document.createElement('div');
         modal.className = 'screen active';
         modal.style.cssText = 'background:var(--bg1);z-index:9000;padding:24px;';
         modal.innerHTML = `
            <div class="stagger" style="height:100%;display:flex;flex-direction:column;">
               <div style="margin-top:40px;">
                  <div style="font-family:var(--font-d);font-size:12px;color:var(--cyan);letter-spacing:4px;">06:00 AM // SYSTEM BOOT</div>
                  <h1 style="font-family:var(--font-d);font-size:2.2rem;margin:10px 0;">MORNING<br>BRIEFING</h1>
               </div>

               <div style="flex:1;display:flex;flex-direction:column;justify-content:center;gap:30px;">
                  <div class="card" style="padding:20px;border-left:4px solid var(--orange);">
                     <div style="font-size:11px;color:var(--orange);font-weight:700;margin-bottom:5px;">STAY ACTIVE</div>
                     <div style="font-family:var(--font-d);font-size:1.8rem;">${user.streak || 0} DAY STREAK</div>
                  </div>

                  <div id="ai-briefing-text" style="font-size:14px;line-height:1.6;color:var(--text);">
                     Good morning, Cadet. Initializing RAGE Core... Analyzing today's mission parameters. 
                  </div>
               </div>

               <button class="btn-cyan" onclick="this.parentElement.parentElement.remove()">ENGAGE THE DAY</button>
            </div>
         `;
         document.body.appendChild(modal);

         const prompt = `Give a short, powerful 2-sentence morning greeting for ${user.name}. Mention their ${user.streak}-day streak. Role: Older brother AI mentor.`;
         fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
         }).then(r => r.json()).then(d => {
            const txt = d.candidates?.[0]?.content?.parts?.[0]?.text || "Let's crush it today.";
            document.getElementById('ai-briefing-text').innerText = txt;
         });
      }
      function getLevelBounds() { const xp = getXP(); const thresholds = [0, 200, 500, 1000, 1800, 2800, 4000, 5500, 7500, 10000, 15000]; const lv = getLevel().lvl; return { cur: thresholds[lv - 1], next: thresholds[lv], xp }; }

      /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         BOOT SEQUENCE
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
      function forceBoot() {
         console.log('Force Booting...');
         if (user && user.name) navigate('war-room');
         else showScreen('login-screen');
      }

      (function bootSequence() {
         const canvas = document.getElementById('matrix-canvas');
         if (!canvas) return;
         const ctx = canvas.getContext('2d');
         canvas.width = window.innerWidth; canvas.height = window.innerHeight;
         const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%';
         const fontSize = 14; const cols = Math.floor(canvas.width / fontSize);
         const drops = Array(cols).fill(1);
         function drawMatrix() {
            ctx.fillStyle = 'rgba(0,0,0,0.05)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#00F5FF'; ctx.font = fontSize + 'px DM Mono';
            for (let i = 0; i < drops.length; i++) {
               const t = chars[Math.floor(Math.random() * chars.length)];
               ctx.fillText(t, i * fontSize, drops[i] * fontSize);
               if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
               drops[i]++;
            }
         }
         const mi = setInterval(drawMatrix, 40);

         // Safety Fallback (8s)
         setTimeout(() => {
            if (currentScreen === 'boot-screen') {
               const btn = document.getElementById('boot-force-btn');
               if (btn) btn.style.display = 'block';
               console.warn("Boot taking too long. Fallback button enabled.");
            }
         }, 8000);

         setTimeout(() => { document.getElementById('boot-logo').style.opacity = '1'; }, 1000);
         setTimeout(() => { document.getElementById('boot-ver').style.opacity = '1'; document.getElementById('boot-ticker').style.opacity = '1'; }, 1500);

         const typingLines = ["Initializing RAGE OS...", "Syncing Cadet data...", "All systems online. Welcome back."];
         let li = 0, ci = 0;
         const ta = document.getElementById('boot-typing');
         function typeNext() {
            if (!ta || li >= typingLines.length) return;
            ta.innerHTML = '> ' + typingLines[li].slice(0, ci) + '<span class="cursor"></span>';
            ci++;
            if (ci > typingLines[li].length) {
               li++; ci = 0; ta.innerHTML += '\n';
               if (li < typingLines.length) setTimeout(typeNext, 400);
            }
            else setTimeout(typeNext, 30);
         }
         setTimeout(typeNext, 2000);

         const bar = document.getElementById('boot-bar');
         let bp = 0;
         const bi = setInterval(() => {
            if (!bar) { clearInterval(bi); return; }
            bp += 1.5;
            bar.style.width = Math.min(bp, 100) + '%';
            if (bp >= 105) { // Extra margin to ensure typing finishes
               clearInterval(bi); clearInterval(mi);
               setTimeout(() => {
                  if (currentScreen === 'boot-screen') forceBoot();
               }, 500);
            }
         }, 50);
      })();

      // Global Error Handler for UI notification
      window.onerror = function (msg, url, lineNo, columnNo, error) {
         console.error('GLOBAL ERROR:', msg, url, lineNo, error);
         // If we're stuck on boot screen, try to force a transition to login
         if (currentScreen === 'boot-screen') {
            setTimeout(() => {
               if (document.getElementById('boot-logo').style.opacity !== '1') {
                  showScreen('login-screen');
               }
            }, 5000);
         }
         return false;
      };

      /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         AUTH
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
      async function doLogin() {
         if (!sb) {
            toast('System not ready. Retry.', 'var(--orange)');
            return;
         }
         const email = document.getElementById('login-email').value.trim();
         const pw = document.getElementById('login-pw').value;
         if (!email || !pw) return toast('Fill all fields', 'var(--orange)');
         toast('Authenticating...', 'var(--muted)');
         try {
            const { data, error } = await sb.auth.signInWithPassword({ email, password: pw });
            if (error) return toast(error.message, 'var(--orange)');
            const { data: profile } = await sb.from('users_public').select('*').eq('id', data.user.id).single();
            user = {
               ...data.user,
               ...(profile || {}),
               name: profile?.name || data.user.user_metadata?.name || data.user.email.split('@')[0]
            };
            save();
            await loadUserData();
            showMorningBriefing();
            navigate('war-room');
            toast('Welcome back, Cadet.', 'var(--cyan)');
         } catch (e) {
            toast('Login failed: ' + e.message, 'var(--orange)');
         }
      }
      async function doSignup() {
         if (!sb) return toast('System not ready', 'var(--orange)');
         const name = document.getElementById('signup-name').value.trim();
         const uname = document.getElementById('signup-user').value.trim();
         const email = document.getElementById('signup-email').value.trim();
         const pw = document.getElementById('signup-pw').value;
         const cpw = document.getElementById('signup-cpw').value;
         if (!name || !uname || !email || !pw) return toast('Fill all fields', 'var(--orange)');
         if (pw !== cpw) return toast('Passwords do not match', 'var(--orange)');
         if (pw.length < 6) return toast('Password min 6 chars', 'var(--orange)');
         toast('Enlisting...', 'var(--muted)');
         try {
            const { data, error } = await sb.auth.signUp({
               email, password: pw,
               options: { data: { name, username: uname } }
            });
            if (error) return toast(error.message, 'var(--orange)');
            await sb.from('users_public').upsert({
               id: data.user.id,
               name,
               username: uname,
               xp: 0,
               streak: 0,
               level: 1,
               subjects: [],
               study_target: 4,
               wake_time: '06:00',
               sleep_time: '23:00',
               archetype: 'THE FOCUSED BUILDER',
               created_at: new Date().toISOString()
            });
            user = {
               ...data.user,
               name, username: uname,
               xp: 0, streak: 0, level: 1,
               subjects: []
            };
            save();
            toast(`Welcome to RAGE OS, ${name}!`, 'var(--cyan)');
            initOnboarding();
            showScreen('onboarding-screen');
         } catch (e) {
            toast('Signup failed: ' + e.message, 'var(--orange)');
         }
      }
      async function doGoogleLogin() {
         const { error } = await sb.auth.signInWithOAuth({ provider: 'google' });
         if (error) toast(error.message, 'var(--orange)');
      }

      async function doLogout() {
         if (sb) await sb.auth.signOut();
         user = null;
         tasks = [];
         goals = [];
         chatHistory = [];
         dailyLog = {};
         localStorage.clear();
         showScreen('login-screen');
         toast('Session terminated', 'var(--orange)');
      }

      /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         ONBOARDING
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
      const SUBJECTS = ['Mathematics', 'Physics', 'Chemistry', 'Biology', 'English', 'History', 'Economics', 'Computer Science', 'Political Science', 'Psychology', 'Sociology', 'Hindi', 'Geography'];
      function initOnboarding() {
         obStepIdx = 0; obGoals = [];
         const pg = document.getElementById('ob-progress'); pg.innerHTML = '';
         for (let i = 0; i < 5; i++) { const d = document.createElement('div'); d.className = 'dot' + (i === 0 ? ' active' : ''); pg.appendChild(d); }
         const sc = document.getElementById('subject-chips'); sc.innerHTML = '';
         SUBJECTS.forEach(s => { const c = document.createElement('button'); c.className = 'chip'; c.textContent = s; c.onclick = () => { c.classList.toggle('selected'); }; sc.appendChild(c); });
         document.getElementById('ob-back').style.display = 'none';
         document.getElementById('ob-next').textContent = 'NEXT';
      }
      function addGoal() {
         const inp = document.getElementById('goal-input');
         if (!inp.value.trim() || obGoals.length >= 5) return;
         obGoals.push(inp.value.trim()); inp.value = ''; renderObGoals();
      }
      function renderObGoals() {
         const l = document.getElementById('goals-list'); l.innerHTML = '';
         obGoals.forEach((g, i) => { l.innerHTML += `<div class="goal-item"><span>${g}</span><button onclick="obGoals.splice(${i},1);renderObGoals()">‚úï</button></div>`; });
      }
      function obStep(dir) {
         const steps = document.querySelectorAll('.onboard-step');
         steps[obStepIdx].classList.remove('active');
         obStepIdx += dir;
         if (obStepIdx >= 5) {
            // Finish onboarding
            const selected = [...document.querySelectorAll('#subject-chips .chip.selected')].map(c => c.textContent);
            user.subjects = selected;
            user.goals = obGoals.map(g => ({ id: uid(), title: g, category: 'Academic', progress: 0, status: 'active', deadline: '', createdAt: new Date().toISOString() }));
            goals = user.goals; save();
            navigate('war-room'); toast("Your journey starts now. Let's build something real."); confetti();
            return;
         }
         if (obStepIdx < 0) obStepIdx = 0;
         steps[obStepIdx].classList.add('active');
         document.querySelectorAll('.onboard-progress .dot').forEach((d, i) => d.classList.toggle('active', i <= obStepIdx));
         document.getElementById('ob-back').style.display = obStepIdx > 0 ? 'block' : 'none';
         document.getElementById('ob-next').textContent = obStepIdx === 4 ? 'LAUNCH' : 'NEXT';
      }

      /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         WAR ROOM
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
      function renderWarRoom() {
         const s = document.getElementById('war-room');
         const today = new Date().toDateString();
         const todayTasks = tasks.filter(t => t.date === today);
         const done = todayTasks.filter(t => t.done).length;
         const battery = getBattery();
         const lv = getLevel();
         const lb = getLevelBounds();
         const pct = lb.next > lb.cur ? Math.round(((lb.xp - lb.cur) / (lb.next - lb.cur)) * 100) : 100;
         s.innerHTML = `
<div style="padding:16px 20px;position:relative;z-index:1;" class="stagger">
<!-- Header -->
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
<div><span style="font-family:var(--font-d);font-size:14px;color:var(--cyan)">RAGE OS</span> <span class="tag tag-green" style="font-size:9px">‚óè V.4.2.0 // ONLINE</span></div>
<div style="display:flex;align-items:center;gap:12px;">
<button onclick="navigate('notifications-screen')" style="background:none;font-size:20px;position:relative;">üîî<span style="position:absolute;top:-2px;right:-2px;width:8px;height:8px;background:var(--orange);border-radius:50%;"></span></button>
<div style="width:36px;height:36px;border-radius:50%;border:2px solid var(--cyan);background:var(--card);display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer;" onclick="navigate('the-commander')">${user?.name ? user.name[0].toUpperCase() : 'S'}</div>
</div>
</div>
<!-- Ticker -->
<div style="overflow:hidden;height:18px;margin-bottom:16px;"><div style="white-space:nowrap;animation:ticker 20s linear infinite;font-family:var(--font-b);font-size:10px;color:var(--muted);">SYSTEM OPTIMAL ‚óè LEARNING MODULES SYNCED ‚óè STREAK: ${user?.streak || 0} DAYS ‚óè BATTERY: ${battery}% ‚óè ${getTimeGreeting()} SESSION</div></div>
<style>@keyframes ticker{0%{transform:translateX(100%);}100%{transform:translateX(-100%);}}</style>
<!-- Clock & Greeting -->
<div style="text-align:center;margin-bottom:20px;">
<div id="live-clock" style="font-family:var(--font-d);font-size:clamp(2.5rem,8vw,4rem);color:var(--cyan);text-shadow:0 0 30px rgba(0,245,255,0.4);letter-spacing:4px;"></div>
<div style="font-family:var(--font-t);font-size:16px;color:var(--muted);letter-spacing:2px;">${getTimeGreeting()}, CADET ${(user?.name || 'SHIVAM').toUpperCase()}.</div>
</div>
<!-- Day Progress -->
<div class="card" style="margin-bottom:12px;padding:14px 16px;">
<div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:6px;"><span style="color:var(--muted)">DAY PROGRESS</span><span style="color:var(--cyan)" id="day-pct">0%</span></div>
<div style="height:4px;background:var(--bg2);border-radius:4px;overflow:hidden;"><div id="day-bar" style="height:100%;background:var(--cyan);border-radius:4px;transition:width .5s;width:0;"></div></div>
</div>
<!-- Battery & XP -->
<div style="display:flex;gap:10px;margin-bottom:16px;">
<div class="card" style="flex:1;text-align:center;padding:14px;">
<div style="font-family:var(--font-d);font-size:1.8rem;color:${battery > 60 ? 'var(--green)' : battery > 30 ? 'var(--orange)' : 'var(--orange)'};">${battery}%</div>
<div style="font-size:11px;color:var(--muted);">BATTERY</div>
</div>
<div class="card" style="flex:1;text-align:center;padding:14px;">
<div style="font-family:var(--font-d);font-size:1.8rem;color:var(--cyan);">LVL ${lv.lvl}</div>
<div style="font-size:11px;color:var(--muted);">${lv.title.toUpperCase()}</div>
</div>
</div>
<!-- Energy Check-in -->
<div class="card" style="margin-bottom:16px;padding:14px 16px;">
<div style="font-size:11px;color:var(--muted);letter-spacing:2px;margin-bottom:10px;">SYSTEM STATUS CHECK</div>
<div style="display:flex;justify-content:center;gap:12px;" id="mood-btns">
${['üò¥', 'üòê', 'üòä', 'üî•', '‚ö°'].map((m, i) => `<button onclick="setMood(${i})" style="font-size:28px;background:none;padding:6px 10px;border-radius:var(--r-sm);border:2px solid ${dailyLog.mood === i ? 'var(--cyan)' : 'transparent'};${dailyLog.mood === i ? 'box-shadow:0 0 12px var(--glow-c);transform:scale(1.15);' : ''}">${m}</button>`).join('')}
</div>
<div id="mood-quote" style="text-align:center;min-height:20px;margin-top:8px;">
${dailyLog.mood !== undefined ? '<span style="font-size:12px;color:var(--cyan);font-style:italic;">Mood logged ‚úì</span>' : ''}
</div>
</div>
<!-- Daily Log -->
<div class="card" style="margin-bottom:16px;padding:14px 16px;">
<div style="font-size:11px;color:var(--muted);letter-spacing:2px;margin-bottom:10px;">DAILY LOG</div>
<div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;">
<span style="font-size:13px;flex:1;">üìö Study Hours</span>
<input type="number" id="study-hrs-input" value="${dailyLog.studyHours || 0}" min="0" max="24" step="0.5" style="width:60px;text-align:center;font-size:14px;" onchange="logStudyHours(this.value)">
</div>
<div style="display:flex;gap:10px;align-items:center;">
<span style="font-size:13px;flex:1;">üí™ Workout Done</span>
<button onclick="toggleWorkout()" style="padding:6px 14px;border-radius:20px;font-size:11px;background:${dailyLog.workout ? 'var(--green)' : 'var(--card2)'};color:${dailyLog.workout ? 'var(--bg1)' : 'var(--muted)'};border:1px solid ${dailyLog.workout ? 'var(--green)' : 'var(--border)'};">${dailyLog.workout ? '‚úì YES' : 'NO'}</button>
</div>
</div>
<!-- Active Missions -->
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
<span style="font-family:var(--font-t);font-weight:700;font-size:15px;letter-spacing:1px;">ACTIVE MISSIONS <span class="tag tag-cyan">${todayTasks.length}</span></span>
</div>
<div id="missions-list" style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;">
${todayTasks.length === 0 ? '<div style="text-align:center;color:var(--muted);padding:20px;font-size:13px;">No missions today. Add one below.</div>' : ''}
${todayTasks.map((t, i) => `
<div class="card" style="padding:12px 14px;display:flex;align-items:center;gap:12px;border-left:3px solid ${t.priority === 'high' ? 'var(--orange)' : t.priority === 'medium' ? 'var(--cyan)' : 'var(--green)'};">
<button onclick="toggleTask(${i})" style="width:24px;height:24px;border-radius:6px;border:2px solid ${t.done ? 'var(--green)' : 'var(--muted)'};background:${t.done ? 'var(--green)' : 'transparent'};color:var(--bg1);font-size:14px;flex-shrink:0;${t.done ? 'box-shadow:0 0 12px rgba(57,255,20,0.4);' : ''}">‚úì</button>
<div style="flex:1;min-width:0;">
<div style="font-family:var(--font-t);font-weight:600;font-size:14px;${t.done ? 'text-decoration:line-through;opacity:0.5;' : ''}">${t.title}</div>
<div style="font-size:11px;color:var(--muted);display:flex;gap:8px;margin-top:2px;">${t.tag ? `<span class="tag tag-purple" style="font-size:9px">${t.tag}</span>` : ''}</div>
</div>
${t.done ? '<span class="tag tag-green" style="font-size:9px">COMPLETE</span>' : ''}
</div>
`).join('')}
</div>
<!-- Add Mission -->
<div style="display:flex;gap:8px;margin-bottom:20px;">
<input type="text" id="new-task" placeholder="New mission..." style="flex:1;font-size:13px;">
<select id="new-task-priority" style="width:90px;font-size:12px;"><option value="medium">Medium</option><option value="high">High</option><option value="low">Low</option></select>
<button onclick="addTask()" style="width:44px;height:44px;border-radius:var(--r-sm);background:var(--cyan);color:var(--bg1);font-size:20px;flex-shrink:0;">+</button>
</div>
<!-- Quick Access Grid -->
<div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:10px;margin-bottom:16px;">
<div class="card" onclick="navigate('the-vault')" style="text-align:center;padding:15px;cursor:pointer;"><div style="font-size:24px;margin-bottom:4px;">üìÅ</div><div style="font-family:var(--font-d);font-size:9px;letter-spacing:1px;">INTEL</div></div>
<div class="card" onclick="navigate('comms-screen')" style="text-align:center;padding:15px;cursor:pointer;"><div style="font-size:24px;margin-bottom:4px;">üí¨</div><div style="font-family:var(--font-d);font-size:9px;letter-spacing:1px;">COMMS</div></div>
<div class="card" onclick="showStudyTimer()" style="text-align:center;padding:15px;cursor:pointer;border-color:var(--cyan);box-shadow:0 0 10px var(--glow-c);"><div style="font-size:24px;margin-bottom:4px;">‚è±Ô∏è</div><div style="font-family:var(--font-d);font-size:9px;letter-spacing:1px;">TIMER</div></div>
<div class="card" onclick="navigate('the-grid')" style="text-align:center;padding:15px;cursor:pointer;"><div style="font-size:24px;margin-bottom:4px;">üìÖ</div><div style="font-family:var(--font-d);font-size:9px;letter-spacing:1px;">OPS</div></div>
<div class="card" onclick="navigate('life-radar')" style="text-align:center;padding:15px;cursor:pointer;"><div style="font-size:24px;margin-bottom:4px;">üìä</div><div style="font-family:var(--font-d);font-size:9px;letter-spacing:1px;">STATS</div></div>
<div class="card" onclick="navigate('the-network')" style="text-align:center;padding:15px;cursor:pointer;"><div style="font-size:24px;margin-bottom:4px;">üåê</div><div style="font-family:var(--font-d);font-size:9px;letter-spacing:1px;">NETWORK</div></div>
</div>
<!-- XP Bar -->
<div class="card" style="padding:14px 16px;">
<div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:6px;"><span>LVL ${lv.lvl} ${lv.title.toUpperCase()}</span><span>${lb.xp} / ${lb.next} XP</span></div>
<div style="height:6px;background:var(--bg2);border-radius:4px;overflow:hidden;"><div style="height:100%;width:${pct}%;background:linear-gradient(90deg,var(--cyan),var(--purple));border-radius:4px;animation:bar-fill 1s ease;"></div></div>
</div>
</div>`;
         // Live clock
         function updateClock() {
            const now = new Date();
            const el = document.getElementById('live-clock');
            if (el) el.textContent = now.toTimeString().slice(0, 8);
            const mins = now.getHours() * 60 + now.getMinutes();
            const dayEl = document.getElementById('day-pct');
            const dayBar = document.getElementById('day-bar');
            const pct = Math.round((mins / 1440) * 100);
            if (dayEl) dayEl.textContent = pct + '%';
            if (dayBar) dayBar.style.width = pct + '%';
         }
         updateClock(); if (!window._clockInt) { window._clockInt = setInterval(updateClock, 1000); }
      }

      function setMood(i) {
         dailyLog.mood = i;
         dailyLog.date = new Date().toDateString();
         save();
         updateStreak();
         if (sb && user?.id) {
            sb.from('daily_logs').upsert({
               user_id: user.id,
               date: new Date().toDateString(),
               mood: i,
               study_hours: dailyLog.studyHours || 0,
               workout: dailyLog.workout || false,
               sleep_on_time: dailyLog.sleepOnTime || false,
               battery_score: getBattery()
            }).catch(e => console.log('Log sync error:', e));
         }
         // Highlight selected mood
         document.querySelectorAll('#mood-btns button').forEach((btn, idx) => {
            btn.style.border = idx === i ? '2px solid var(--cyan)' : '2px solid transparent';
            btn.style.boxShadow = idx === i ? '0 0 12px var(--glow-c)' : 'none';
            btn.style.transform = idx === i ? 'scale(1.15)' : 'scale(1)';
         });
         // Show mood quote
         const quoteEl = document.getElementById('mood-quote');
         if (quoteEl) {
            const fallbacks = [
               'Every rep counts. Every page matters. Keep moving.',
               'Discipline is choosing between what you want now and what you want most.',
               'The grind doesn\'t stop. Neither do you.',
               'Small steps daily. Massive results eventually.',
               'You\'re building something most people can\'t even imagine.'
            ];
            quoteEl.innerHTML = '<span style="color:var(--muted);font-size:11px;">Loading wisdom...</span>';
            callGemini(`Give me a single motivational sentence for someone feeling ${['low energy', 'neutral', 'good', 'on fire', 'beast mode'][i]}. Max 15 words. No quotes.`)
               .then(quote => {
                  if (quote && !quote.includes('Signal lost')) {
                     quoteEl.innerHTML = `<span style="font-size:12px;color:var(--cyan);font-style:italic;">"${quote}"</span>`;
                  } else {
                     quoteEl.innerHTML = `<span style="font-size:12px;color:var(--cyan);font-style:italic;">"${fallbacks[i]}"</span>`;
                  }
               }).catch(() => {
                  quoteEl.innerHTML = `<span style="font-size:12px;color:var(--cyan);font-style:italic;">"${fallbacks[i]}"</span>`;
               });
         }
      }
      function addTask() {
         const inp = document.getElementById('new-task'); const pr = document.getElementById('new-task-priority');
         if (!inp.value.trim()) return;
         tasks.push({ id: uid(), title: inp.value.trim(), priority: pr.value, date: new Date().toDateString(), done: false, tag: user?.subjects?.[0] || '', xpReward: 10, createdAt: new Date().toISOString() });
         inp.value = ''; save(); renderWarRoom(); toast('Mission added');
      }
      function toggleTask(i) {
         const today = new Date().toDateString();
         const todayTasks = tasks.filter(t => t.date === today);
         const task = todayTasks[i];
         const realIdx = tasks.findIndex(t => t.id === task.id);
         if (realIdx >= 0) {
            tasks[realIdx].done = !tasks[realIdx].done;
            if (tasks[realIdx].done) {
               addXP(10);
               updateStreak();
               confetti();
               haptic('success');
            } else {
               haptic('medium');
            }
            save();
            renderWarRoom();
         }
      }
      /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      THE GRID (TIMETABLE)
      ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
      function renderGrid() {
         const s = document.getElementById('the-grid');
         const days = [];
         const now = new Date();
         for (let i = 0; i < 7; i++) {
            const d = new Date();
            d.setDate(now.getDate() + i);
            days.push(d);
         }

         s.innerHTML = `
    <div style="padding:16px 20px;" class="stagger">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h1 style="font-family:var(--font-d);font-size:1.5rem;color:var(--cyan);letter-spacing:1px;">THE GRID</h1>
            <div style="display:flex;gap:15px;"><span>üìÖ</span><span>üîç</span></div>
        </div>
        
        <!-- Date Strip -->
        <div style="display:flex;gap:10px;overflow-x:auto;padding-bottom:10px;margin-bottom:20px;scrollbar-width:none;">
            ${days.map((d, i) => {
            const isSelected = i === 0; // Default to today
            return `
                <div class="${isSelected ? 'active' : ''}" style="flex-shrink:0;width:60px;height:80px;background:${isSelected ? 'var(--cyan)' : 'var(--card)'};border-radius:var(--r-md);display:flex;flex-direction:column;align-items:center;justify-content:center;border:1px solid ${isSelected ? 'var(--cyan)' : 'var(--border)'};box-shadow:${isSelected ? '0 0 15px var(--glow-c)' : 'none'};">
                    <div style="font-size:10px;color:${isSelected ? 'var(--bg1)' : 'var(--muted)'};font-family:var(--font-d);">${d.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase()}</div>
                    <div style="font-size:20px;color:${isSelected ? 'var(--bg1)' : 'var(--text)'};font-family:var(--font-d);margin-top:4px;">${d.getDate()}</div>
                </div>
                `;
         }).join('')}
        </div>
        
        <button class="btn-cyan" style="background:linear-gradient(135deg, var(--cyan), var(--purple));margin-bottom:20px;display:flex;align-items:center;justify-content:center;gap:10px;" onclick="aiBuildDay()">
            <span>‚ú¶</span> AI BUILD MY DAY
        </button>
        
        <!-- Time Grid -->
        <div style="position:relative;margin-top:10px;">
            ${Array.from({ length: 18 }, (_, i) => i + 6).map(h => `
                <div style="display:flex;align-items:center;height:60px;border-top:1px solid rgba(255,255,255,0.03);">
                    <div style="width:50px;font-size:10px;color:var(--muted);font-family:var(--font-d);">${String(h).padStart(2, '0')}:00</div>
                    <div style="flex:1;"></div>
                </div>
            `).join('')}
            
            <!-- NOW Line -->
            <div id="now-line" style="position:absolute;left:0;right:0;height:1px;background:var(--orange);z-index:5;pointer-events:none;display:flex;align-items:center;">
                <div style="background:var(--orange);color:#fff;font-size:8px;padding:2px 4px;border-radius:2px;font-family:var(--font-d);margin-left:45px;">NOW</div>
            </div>
            
            <!-- Dummy Blocks -->
            <div class="card" style="position:absolute;top:60px;left:60px;right:0;height:115px;background:rgba(0,245,255,0.1);border-left:4px solid var(--cyan);padding:10px;">
                <div style="font-family:var(--font-t);font-weight:700;font-size:14px;">Deep Study</div>
                <div style="font-size:11px;color:var(--muted);">Mathematics / Calculus</div>
                <div style="position:absolute;bottom:10px;font-size:10px;color:var(--cyan);">07:00 - 09:00</div>
            </div>
        </div>
    </div>
    <button style="position:fixed;bottom:90px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--cyan);color:var(--bg1);font-size:24px;box-shadow:0 0 20px var(--glow-c);z-index:10;" onclick="toast('Add block feature coming soon')">+</button>
    `;

         updateNowLine();
      }

      function updateNowLine() {
         const line = document.getElementById('now-line');
         if (!line) return;
         const now = new Date();
         const hours = now.getHours();
         const mins = now.getMinutes();
         if (hours < 6 || hours > 23) {
            line.style.display = 'none';
            return;
         }
         const pixels = (hours - 6) * 60 + mins;
         line.style.top = pixels + 'px';
      }

      async function aiBuildDay() {
         const btn = document.querySelector('button[onclick="aiBuildDay()"]');
         const oldText = btn.innerText;
         btn.innerText = "‚è≥ CONSULTING RAGE AI...";
         btn.disabled = true;

         const profile = user || {};
         const goalsData = goals || [];
         const moodLabel = dailyLog.mood !== undefined ? ['üò¥ Low energy', 'üòê Neutral', 'üòä Good', 'üî• On fire', '‚ö° Beast mode'][dailyLog.mood] : 'Not logged yet';

         const prompt = `You are RAGE AI. Build an optimal daily timetable for ${profile.name || 'Shivam'}. 

Their data:
- Study target: ${profile.studyTarget || 4}h
- Wake time: ${profile.wakeTime || '06:00'}
- Sleep time: ${profile.sleepTime || '23:00'}  
- Subjects: ${(profile.subjects || []).join(', ')}
- Goals: ${goalsData.map(g => g.title).join(', ')}
- Today's mood: ${moodLabel}

Return ONLY a JSON array, no other text:
[
  {
    "startTime": "07:00",
    "endTime": "09:00", 
    "type": "Deep Study",
    "subject": "Mathematics",
    "color": "cyan"
  }
]

Types allowed: Deep Study, Revision, Exercise, Break, Meal, Social, Sleep
Colors: cyan, green, purple, orange, grey`;

         try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({
                  contents: [{ parts: [{ text: prompt }] }],
                  generationConfig: { temperature: 0.7, maxOutputTokens: 1000 }
               })
            });
            const data = await res.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '[]';
            const cleanJson = text.replace(/```json|```/g, '').trim();
            const blocks = JSON.parse(cleanJson);

            timetable = blocks;
            save();
            renderGrid();
            confetti();
            toast('Schedule Optimized', 'var(--green)');
         } catch (e) {
            console.error(e);
            toast('AI logic failed. Check connection.', 'var(--orange)');
         } finally {
            btn.innerText = oldText;
            btn.disabled = false;
         }
      }

      /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         RAGE CORE (AI)
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
      function renderRageCore() {
         const s = document.getElementById('rage-core');
         s.innerHTML = `
    <div style="padding:16px 20px;height:100%;display:flex;flex-direction:column;" class="stagger">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h1 style="font-family:var(--font-d);font-size:1.5rem;color:var(--purple);letter-spacing:1px;">RAGE CORE</h1>
            <span>‚öôÔ∏è</span>
        </div>
        
        <div style="text-align:center;margin-bottom:10px;">
            <div style="font-family:var(--font-d);font-size:10px;color:var(--cyan);letter-spacing:2px;">ONLINE</div>
            <div style="font-size:10px;color:var(--muted);margin-top:4px;">SYSTEM OPTIMAL ¬∑ LEVEL 4 CLEARANCE</div>
        </div>
        
        <!-- AI Orb -->
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:30px;">
            <div id="ai-orb" style="width:120px;height:120px;background:linear-gradient(135deg, var(--cyan), var(--purple));animation:morph 4s infinite linear;box-shadow:0 0 60px rgba(0,245,255,0.4);display:flex;align-items:center;justify-content:center;">
                <span style="font-size:40px;">ü§ñ</span>
            </div>
            
            <!-- Insight Pills -->
            <div style="display:flex;gap:10px;overflow-x:auto;width:100%;padding:10px 0;scrollbar-width:none;">
                <div class="card" style="flex-shrink:0;padding:8px 15px;border-radius:20px;display:flex;align-items:center;gap:8px;">
                    <span style="display:block;width:6px;height:6px;background:var(--cyan);border-radius:50%;"></span>
                    <span style="font-size:11px;white-space:nowrap;">üìö Study: ${dailyLog.studyHours ? dailyLog.studyHours.toFixed(1) + 'h today' : 'No data yet'}</span>
                </div>
                <div class="card" style="flex-shrink:0;padding:8px 15px;border-radius:20px;display:flex;align-items:center;gap:8px;">
                    <span style="display:block;width:6px;height:6px;background:var(--purple);border-radius:50%;"></span>
                    <span style="font-size:11px;white-space:nowrap;">‚ö° Battery: ${getBattery()}%</span>
                </div>
                <div class="card" style="flex-shrink:0;padding:8px 15px;border-radius:20px;display:flex;align-items:center;gap:8px;">
                    <span style="display:block;width:6px;height:6px;background:var(--orange);border-radius:50%;"></span>
                    <span style="font-size:11px;white-space:nowrap;">üî• Streak: ${user?.streak || 0} days</span>
                </div>
            </div>
        </div>
        
        <!-- Chat Area -->
        <div id="chat-messages" style="flex:1;overflow-y:auto;padding:10px 0;display:flex;flex-direction:column;gap:15px;margin-bottom:80px;">
            <div style="display:flex;gap:10px;max-width:85%;">
                <div style="width:30px;height:30px;border-radius:50%;background:var(--purple);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;">ü§ñ</div>
                <div class="card" style="padding:12px;border-left:3px solid var(--purple);border-bottom-left-radius:4px;">
                    <div style="font-size:13px;line-height:1.5;">Good evening, Cadet. Your focus metrics are dipping. Suggest re-engaging with your primary mission goal.</div>
                </div>
            </div>
        </div>
        
        <!-- Input -->
        <div style="position:fixed;bottom:85px;left:20px;right:20px;max-width:440px;margin:0 auto;z-index:101;">
            <div class="card" style="padding:10px;display:flex;align-items:center;gap:10px;border-radius:30px;background:rgba(10,15,30,0.95);backdrop-filter:blur(10px);">
                <button style="background:none;font-size:20px;padding:5px;">+</button>
                <input type="text" id="chat-input" placeholder="Talk to RAGE..." style="flex:1;border:none;background:none;padding:8px;font-size:14px;">
                <button onclick="sendChatMessage()" style="background:none;font-size:20px;color:var(--cyan);padding:5px;">‚û§</button>
            </div>
        </div>
    </div>
    `;

         // Auto-scroll chat
         const chat = document.getElementById('chat-messages');
         chat.scrollTop = chat.scrollHeight;
      }

      async function sendChatMessage() {
         const inp = document.getElementById('chat-input');
         const msg = inp.value.trim();
         if (!msg) return;

         const chat = document.getElementById('chat-messages');
         chat.innerHTML += `
    <div style="display:flex;gap:10px;max-width:85%;margin-left:auto;justify-content:flex-end;">
        <div class="card" style="padding:12px;background:rgba(0,245,255,0.05);border-color:rgba(0,245,255,0.2);border-bottom-right-radius:4px;">
            <div style="font-size:13px;line-height:1.5;">${msg}</div>
        </div>
    </div>
    `;
         inp.value = '';
         chat.scrollTop = chat.scrollHeight;

         // Save history
         chatHistory.push({ role: 'user', content: msg, timestamp: Date.now() });
         save();

         // AI Thinking state
         const orb = document.getElementById('ai-orb');
         orb.style.animationDuration = '1s';
         orb.style.boxShadow = '0 0 80px rgba(255,107,53,0.5)';

         // Show typing indicator
         const typingId = 'typing-' + Date.now();
         chat.innerHTML += `
    <div id="${typingId}" style="display:flex;gap:10px;max-width:85%;">
        <div style="width:30px;height:30px;border-radius:50%;background:var(--purple);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;">ü§ñ</div>
        <div class="card" style="padding:12px;border-left:3px solid var(--purple);border-bottom-left-radius:4px;">
            <div style="font-size:13px;line-height:1.5;color:var(--muted);"><span class="typing-dots">Thinking<span>.</span><span>.</span><span>.</span></span></div>
        </div>
    </div>
    `;
         chat.scrollTop = chat.scrollHeight;

         const reply = await callGemini(msg);

         orb.style.animationDuration = '4s';
         orb.style.boxShadow = '0 0 60px rgba(0,245,255,0.4)';

         // Remove typing indicator
         const typingEl = document.getElementById(typingId);
         if (typingEl) typingEl.remove();

         // Save response
         chatHistory.push({ role: 'rage', content: reply, timestamp: Date.now() });
         save();

         chat.innerHTML += `
        <div style="display:flex;gap:10px;max-width:85%;">
            <div style="width:30px;height:30px;border-radius:50%;background:var(--purple);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;">ü§ñ</div>
            <div class="card" style="padding:12px;border-left:3px solid var(--purple);border-bottom-left-radius:4px;">
                <div style="font-size:13px;line-height:1.5;">${reply}</div>
            </div>
        </div>
        `;
         chat.scrollTop = chat.scrollHeight;
      }

      function renderRadar() {
         const s = document.getElementById('life-radar');
         s.innerHTML = `
    <div style="padding:16px 20px;" class="stagger">
        <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
            <div><span style="font-family:var(--font-d);font-size:12px;color:var(--cyan)">RAGE OS</span> <span class="tag tag-green" style="font-size:9px">‚óè V.4.2.0 // ONLINE</span></div>
            <div style="color:var(--cyan);font-family:var(--font-d);font-size:12px;">85% OPTIMAL</div>
        </div>
        <h1 style="font-family:var(--font-d);font-size:1.5rem;color:var(--text);margin-bottom:4px;">LIFE RADAR</h1>
        <div style="font-size:10px;color:var(--muted);margin-bottom:20px;">BIOMETRIC & ACADEMIC SYNC</div>
        
        <!-- Radar Chart -->
        <div style="display:flex;justify-content:center;margin-bottom:30px;">
            <svg width="250" height="250" viewBox="0 0 250 250" style="filter:drop-shadow(0 0 10px rgba(0,245,255,0.2));">
                <!-- Grid -->
                ${[1, 0.8, 0.6, 0.4, 0.2].map(scale => {
            const pts = [];
            for (let i = 0; i < 6; i++) {
               const r = 100 * scale;
               const a = (Math.PI / 3) * i - Math.PI / 2;
               pts.push(`${125 + r * Math.cos(a)},${125 + r * Math.sin(a)}`);
            }
            return `<polygon points="${pts.join(' ')}" fill="none" stroke="rgba(0,245,255,0.08)" stroke-width="1" />`;
         }).join('')}
                <!-- Axes -->
                ${Array.from({ length: 6 }).map((_, i) => {
            const a = (Math.PI / 3) * i - Math.PI / 2;
            return `<line x1="125" y1="125" x2="${125 + 100 * Math.cos(a)}" y2="${125 + 100 * Math.sin(a)}" stroke="rgba(0,245,255,0.08)" stroke-width="1" />`;
         }).join('')}
                <!-- Data -->
                <polygon points="125,55 190,100 180,170 125,200 70,170 60,100" fill="rgba(0,245,255,0.15)" stroke="var(--cyan)" stroke-width="2" style="animation: fadeUp 1s ease forwards;" />
            </svg>
        </div>
        
        <div style="display:flex;justify-content:space-around;margin-bottom:20px;">
            <div class="card" style="padding:10px;text-align:center;flex:1;margin:0 5px;">
                <div style="font-family:var(--font-d);font-size:18px;color:var(--cyan);">${dailyLog.studyHours ? dailyLog.studyHours.toFixed(1) + 'h' : '0h'}</div>
                <div style="font-size:9px;color:var(--muted);">STUDY TODAY</div>
            </div>
            <div class="card" style="padding:10px;text-align:center;flex:1;margin:0 5px;">
                <div style="font-family:var(--font-d);font-size:18px;color:var(--cyan);">${getBattery()}</div>
                <div style="font-size:9px;color:var(--muted);">BATTERY</div>
            </div>
            <div class="card" style="padding:10px;text-align:center;flex:1;margin:0 5px;">
                <div style="font-family:var(--font-d);font-size:18px;color:var(--cyan);">${user?.streak || 0}d</div>
                <div style="font-size:9px;color:var(--muted);">STREAK</div>
            </div>
        </div>
        
        <div class="card" style="margin-bottom:20px;border-left:3px solid var(--purple);overflow:visible;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <span style="font-family:var(--font-t);font-weight:700;font-size:13px;">WEEKLY DEBRIEF</span>
                <span class="tag tag-purple">AAR PROTOCOL</span>
            </div>
            <div id="debrief-content" style="font-size:11px;color:var(--muted);line-height:1.6;margin-bottom:15px;">
                Initialise RAGE analysis to generate your tactical After Action Report.
            </div>
            <button class="btn-cyan" style="font-size:10px;padding:8px;" id="debrief-btn" onclick="generateWeeklyDebrief()">GENERATE AAR</button>
        </div>
        
        <div style="font-family:var(--font-t);font-weight:700;font-size:13px;margin-bottom:10px;">CONSISTENCY MATRIX</div>
        <div class="card" style="padding:12px;">
            <div style="display:grid;grid-template-columns:repeat(12, 1fr);gap:4px;">
                ${Array.from({ length: 48 }).map((_, i) => `<div style="height:12px;background:${i % 7 === 0 ? 'var(--cyan)' : i % 3 === 0 ? 'rgba(0,245,255,0.4)' : 'rgba(255,255,255,0.05)'};border-radius:2px;"></div>`).join('')}
            </div>
        </div>
    </div>
    `;
      }

      function renderVault() {
         const s = document.getElementById('the-vault');
         const userSubjects = user?.subjects || [];
         const fileCount = tasks.length;
         s.innerHTML = `
    <div style="padding:16px 20px;" class="stagger">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h1 style="font-family:var(--font-d);font-size:1.5rem;color:var(--cyan);letter-spacing:1px;">THE VAULT</h1>
            <span>üîç</span>
        </div>
        
        <div class="card" style="margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                <span style="font-size:11px;color:var(--muted);">STORAGE STATUS</span>
                <span class="tag tag-green">ENCRYPTED</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:baseline;">
                <span style="font-family:var(--font-d);font-size:1.8rem;color:var(--cyan);">${fileCount} files</span>
                <span style="font-size:10px;color:var(--muted);">logged</span>
            </div>
        </div>
        
        <div style="font-family:var(--font-t);font-weight:700;font-size:14px;margin-bottom:12px;">SUBJECT_DIRECTORIES</div>
        ${userSubjects.length > 0 ? `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;">
            ${userSubjects.map(sub => `
                <div class="card" style="padding:15px;display:flex;flex-direction:column;gap:8px;">
                    <div style="font-size:24px;">üìÅ</div>
                    <div style="font-family:var(--font-t);font-weight:700;font-size:13px;">${sub}</div>
                    <div style="font-size:9px;color:var(--muted);">${tasks.filter(t => t.tag === sub).length} FILES</div>
                </div>
            `).join('')}
        </div>
        ` : `
        <div class="card" style="text-align:center;padding:30px;margin-bottom:20px;color:var(--muted);">
            <div style="font-size:30px;margin-bottom:10px;">üìÇ</div>
            <div style="font-size:12px;">No subject directories yet. Select subjects in onboarding or edit profile.</div>
        </div>
        `}
        
        <div style="font-family:var(--font-t);font-weight:700;font-size:14px;margin-bottom:12px;">RECENT_ACTIVITY</div>
        <div style="display:flex;flex-direction:column;gap:10px;">
            ${tasks.slice(-3).reverse().map(t => `
            <div class="card" style="padding:12px;display:flex;align-items:center;gap:12px;">
                <span style="font-size:20px;">${t.done ? '‚úÖ' : 'üìù'}</span>
                <div style="flex:1;">
                    <div style="font-size:13px;font-family:var(--font-t);font-weight:600;">${t.title}</div>
                    <div style="font-size:10px;color:var(--muted);">${t.date || 'No date'} ${t.tag ? '‚Ä¢ ' + t.tag : ''}</div>
                </div>
            </div>
            `).join('') || '<div style="text-align:center;color:var(--muted);font-size:11px;padding:15px;">No activity logged yet.</div>'}
        </div>
    </div>
    `;
      }
      function renderNorthStar() {
         const s = document.getElementById('north-star');
         const activeGoals = goals.filter(g => g.status === 'active');
         const critical = activeGoals[0] || null;

         s.innerHTML = `
    <div style="padding:16px 20px;" class="stagger">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <h1 style="font-family:var(--font-d);font-size:1.5rem;color:var(--text);letter-spacing:1px;">THE NORTH STAR</h1>
            <span>üîî</span>
        </div>
        
        <div style="display:flex;gap:10px;margin-bottom:20px;">
            <div class="tag tag-cyan" style="flex:1;text-align:center;padding:8px;">ACTIVE DIRECTIVES: ${activeGoals.length.toString().padStart(2, '0')}</div>
            <div class="tag tag-orange" style="flex:1;text-align:center;padding:8px;">CRITICAL ALERTS: ${critical ? '01' : '00'}</div>
        </div>
        
        <!-- Critical Mission -->
        ${critical ? `
        <div class="card" style="margin-bottom:20px;border:1px solid var(--orange);box-shadow:0 0 15px var(--glow-o);">
            <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                <span style="font-family:var(--font-d);font-size:10px;color:var(--orange);">‚ö†Ô∏è CRITICAL MISSION</span>
                <span class="tag tag-orange">DIRECT</span>
            </div>
            <div style="font-family:var(--font-d);font-size:1.2rem;color:var(--text);margin-bottom:4px;">${critical.title.toUpperCase()}</div>
            <div style="font-size:10px;color:var(--muted);margin-bottom:15px;">Target Acquisition: ${critical.deadline || 'PENDING'}</div>
            
            <div style="height:6px;background:var(--bg2);border-radius:4px;overflow:hidden;margin-bottom:8px;">
                <div style="width:${critical.progress || 0}%;height:100%;background:var(--orange);"></div>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-bottom:15px;">
                <span>${critical.progress || 0}% COMPLETE</span>
                <span>INITIATED: ${new Date(critical.created_at).toLocaleDateString('en-US', { month: 'short', year: 'numeric' }).toUpperCase()}</span>
            </div>
            
            <button class="btn-orange" style="padding:10px;font-size:12px;" onclick="navigate('the-grid')">RESUME PROTOCOL ‚Üí</button>
        </div>
        ` : '<div class="card" style="text-align:center;padding:20px;color:var(--muted);margin-bottom:20px;">No critical mission assigned.</div>'}
        
        <div style="font-family:var(--font-t);font-weight:700;font-size:14px;margin-bottom:12px;">ACTIVE_DIRECTIVES</div>
        <div id="goals-sync-list" style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px;">
            ${activeGoals.length > 0 ? activeGoals.map(g => `
                <div class="card" style="margin-bottom:10px;">
                    <div style="font-family:var(--font-t);font-weight:700;font-size:14px;margin-bottom:4px;">${g.title.toUpperCase()}</div>
                    <div style="font-size:10px;color:var(--muted);margin-bottom:10px;">Category: ${g.category} ‚Ä¢ ${g.progress}% Progress</div>
                    <div style="height:3px;background:var(--bg2);border-radius:2px;overflow:hidden;">
                        <div style="width:${g.progress}%;height:100%;background:var(--cyan);"></div>
                    </div>
                </div>
            `).join('') : '<div style="color:var(--muted);font-size:11px;">No active directives.</div>'}
        </div>
        
        <div class="card" style="padding:15px;border-style:dashed;">
           <input type="text" id="goal-title-input" placeholder="New Directive Title..." style="width:100%;background:none;border:none;border-bottom:1px solid var(--border);color:var(--text);font-size:13px;padding:8px 0;margin-bottom:10px;">
           <button class="btn-cyan" style="font-size:10px;padding:8px;" onclick="addNewGoal()">+ INITIATE NEW DIRECTIVE</button>
        </div>
    </div>
    `;
      }

      async function addNewGoal() {
         const title = document.getElementById('goal-title-input').value.trim();
         if (!title) return toast('Directive title required', 'var(--orange)');

         const newGoal = {
            id: uid(),
            user_id: user.id,
            title,
            category: 'Personal',
            progress: 0,
            status: 'active',
            deadline: '2026-12-31',
            created_at: new Date().toISOString()
         };

         goals.push(newGoal);
         save();
         renderNorthStar();
         toast('New Directive Established', 'var(--cyan)');
      }

      async function renderCommander() {
         const s = document.getElementById('the-commander');
         const lv = getLevel();
         const lb = getLevelBounds();
         const pct = lb.next > lb.cur ? Math.round(((lb.xp - lb.cur) / (lb.next - lb.cur)) * 100) : 100;

         let followerCount = 0;
         let followingCount = 0;
         let postCount = 0;
         try {
            const [f1, f2, p] = await Promise.all([
               sb.from('followers').select('*', { count: 'exact', head: true }).eq('following_id', user?.id),
               sb.from('followers').select('*', { count: 'exact', head: true }).eq('follower_id', user?.id),
               sb.from('posts').select('*', { count: 'exact', head: true }).eq('user_id', user?.id)
            ]);
            followerCount = f1.count || 0;
            followingCount = f2.count || 0;
            postCount = p.count || 0;
         } catch (e) { }

         const earned = JSON.parse(localStorage.getItem('rage_badges') || '[]');
         const allBadges = [
            { id: 'first_task', icon: 'üéØ', name: 'First Mission' },
            { id: 'streak_5', icon: 'üî•', name: '5-Day Warrior' },
            { id: 'streak_14', icon: '‚öîÔ∏è', name: 'Iron Cadet' },
            { id: 'streak_30', icon: 'üëë', name: 'Legend' },
            { id: 'level_5', icon: '‚≠ê', name: 'Operative' },
            { id: 'level_10', icon: 'üíé', name: 'Elite' },
            { id: 'tasks_10', icon: 'üöÄ', name: 'Mission Runner' },
            { id: 'tasks_50', icon: 'üèÜ', name: 'Chapter Boss' }
         ];

         s.innerHTML = `
    <div style="padding:16px 20px;" class="stagger">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;">
      <h1 style="font-family:var(--font-d);font-size:1.5rem;color:var(--text);letter-spacing:1px;">THE COMMANDER</h1>
      <button onclick="showEditProfile()" class="btn-outline" style="padding:6px 14px;font-size:10px;width:auto;">EDIT PROFILE</button>
  </div>
  
  <!-- Hero -->
  <div style="display:flex;flex-direction:column;align-items:center;margin-bottom:30px;">
      <div style="width:100px;height:100px;border-radius:50%;border:3px solid var(--cyan);padding:4px;margin-bottom:15px;box-shadow:0 0 20px var(--glow-c);overflow:hidden;">
          <div style="width:100%;height:100%;border-radius:50%;background:var(--card);display:flex;align-items:center;justify-content:center;font-size:40px;overflow:hidden;">${user?.avatar_url ? `<img src="${user.avatar_url}" style="width:100%;height:100%;object-fit:cover;">` : user?.name?.[0].toUpperCase()}</div>
      </div>
      <h2 style="font-family:var(--font-d);font-size:1.4rem;">${(user?.name || 'Shivam').toUpperCase()}</h2>
      <div style="font-size:11px;color:var(--muted);margin-top:4px;">@${user?.username || 'cadet'} ${user?.location ? '‚Ä¢ üìç ' + user.location : ''}</div>
      <div style="font-family:var(--font-t);font-size:13px;color:var(--cyan);letter-spacing:2px;margin-top:5px;">LEVEL ${lv.lvl} ${lv.title.toUpperCase()}</div>
      ${user?.bio ? `<div style="font-size:12px;color:var(--muted);margin-top:8px;text-align:center;max-width:280px;line-height:1.5;">${user.bio}</div>` : ''}
      
      <div style="width:100%;max-width:300px;margin-top:20px;">
          <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--muted);margin-bottom:6px;">
              <span>XP PROGRESS</span>
              <span>${lb.xp} / ${lb.next}</span>
          </div>
          <div style="height:6px;background:var(--bg2);border-radius:4px;overflow:hidden;">
              <div style="width:${pct}%;height:100%;background:linear-gradient(90deg, var(--cyan), var(--purple));"></div>
          </div>
          <div style="font-size:9px;color:var(--muted);text-align:center;margin-top:6px;">${lb.next - lb.xp} XP TO LEVEL ${lv.lvl + 1}</div>
      </div>

      <div style="display:flex;gap:20px;justify-content:center;margin-top:20px;">
        <div style="text-align:center;">
          <div style="font-family:var(--font-d);font-size:1.2rem;color:var(--cyan);">${followerCount}</div>
          <div style="font-size:10px;color:var(--muted);">FOLLOWERS</div>
        </div>
        <div style="text-align:center;">
          <div style="font-family:var(--font-d);font-size:1.2rem;color:var(--cyan);">${followingCount}</div>
          <div style="font-size:10px;color:var(--muted);">FOLLOWING</div>
        </div>
        <div style="text-align:center;">
          <div style="font-family:var(--font-d);font-size:1.2rem;color:var(--cyan);">${postCount}</div>
          <div style="font-size:10px;color:var(--muted);">POSTS</div>
        </div>
      </div>
  </div>
  
  <!-- Stats Grid -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:30px;">
      <div class="card" style="padding:15px;">
          <div style="font-size:10px;color:var(--muted);margin-bottom:5px;">STUDY HOURS</div>
          <div style="font-family:var(--font-d);font-size:1.2rem;color:var(--text);">${Math.round((dailyLog.studyHours || 0) * 10) / 10} h</div>
      </div>
      <div class="card" style="padding:15px;">
          <div style="font-size:10px;color:var(--muted);margin-bottom:5px;">DAY STREAK</div>
          <div style="font-family:var(--font-d);font-size:1.2rem;color:var(--text);">${user?.streak || 0} üî•</div>
      </div>
      <div class="card" style="padding:15px;">
          <div style="font-size:10px;color:var(--muted);margin-bottom:5px;">TASKS CRUSHED</div>
          <div style="font-family:var(--font-d);font-size:1.2rem;color:var(--text);">${tasks.filter(t => t.done).length} ‚öîÔ∏è</div>
      </div>
      <div class="card" style="padding:15px;">
          <div style="font-size:10px;color:var(--muted);margin-bottom:5px;">BATTERY LEVEL</div>
          <div style="font-family:var(--font-d);font-size:1.2rem;color:var(--text);">${getBattery()}% ‚ö°</div>
      </div>
  </div>
  
  <!-- Achievements -->
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
      <span style="font-family:var(--font-t);font-weight:700;font-size:14px;">ACHIEVEMENTS</span>
      <span style="font-size:11px;color:var(--cyan);">View All</span>
  </div>
  <div style="display:flex;gap:12px;overflow-x:auto;padding-bottom:10px;margin-bottom:30px;scrollbar-width:none;">
    ${allBadges.map(b => {
            const isEarned = earned.includes(b.id);
            return `
      <div style="flex-shrink:0;width:56px;height:56px;background:var(--card);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;border:1px solid ${isEarned ? 'var(--cyan)' : 'var(--border)'};box-shadow:${isEarned ? '0 0 10px var(--glow-c)' : 'none'};opacity:${isEarned ? 1 : 0.3};" title="${b.name}">
        ${b.icon}
      </div>`;
         }).join('')}
  </div>
  
  <!-- Personality -->
  <div class="card" style="padding:20px;border-left:4px solid var(--cyan);">
      <div style="font-family:var(--font-t);font-weight:700;font-size:14px;margin-bottom:5px;">RAGE PERSONALITY REPORT</div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:15px;">Analysing complete. Updating weekly.</div>
      <div style="font-size:14px;font-family:var(--font-d);color:var(--cyan);margin-bottom:10px;">ARCHETYPE: ${user.archetype || 'THE FOCUSED BUILDER'}</div>
      <p style="font-size:11px;color:var(--muted);line-height:1.6;margin-bottom:15px;">You exhibit high-consistency patterns in early morning study blocks. Strategy: maintain current velocity to reach Level 8 </p>
            <div style="display:flex;gap:8px;">
                <span class="tag tag-cyan">Analytical</span>
                <span class="tag tag-cyan">Disciplined</span>
                <span class="tag tag-cyan">Strategist</span>
            </div>
        </div>

        <button class="btn-orange" style="margin-top:40px;background:rgba(255,107,53,0.1);border:1px solid var(--orange);color:var(--orange);box-shadow:none;" onclick="doLogout()">TERMINATE SESSION</button>
    </div>
    `;
      }

      async function renderNetwork() {
         const s = document.getElementById('the-network');
         s.innerHTML = `
    <div style="padding:16px 20px;" class="stagger">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h1 style="font-family:var(--font-d);font-size:1.5rem;color:var(--text);letter-spacing:1px;">THE NETWORK</h1>
            <div style="display:flex;gap:15px;"><span>üîî</span><div style="width:30px;height:30px;border-radius:50%;background:var(--card);border:1px solid var(--border);"></div></div>
        </div>

        <div style="display:flex;gap:10px;margin-bottom:20px;">
          <input type="text" id="user-search" placeholder="Search cadets by @username..." style="flex:1;font-size:13px;" oninput="searchCadets(this.value)">
        </div>
        <div id="search-results" style="margin-bottom:20px;display:flex;flex-direction:column;gap:10px;"></div>
        
        <!-- Fix 7: Stories Row -->
        <div id="stories-row" style="display:flex;gap:12px;overflow-x:auto;padding-bottom:15px;margin-bottom:10px;scrollbar-width:none;">
           <div style="width:60px;flex-shrink:0;text-align:center;" onclick="showStoryModal()">
               <div style="width:56px;height:56px;border-radius:50%;border:2px dashed var(--muted);display:flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:4px;">+</div>
               <div style="font-size:9px;color:var(--muted);">YOUR STORY</div>
           </div>
        </div>

        <!-- Squad Status (Fix 9) -->
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <span style="font-family:var(--font-t);font-weight:700;font-size:14px;">SQUAD STATUS</span>
            <span class="tag tag-cyan" style="font-size:9px">SQUAD_SYNC_ON</span>
        </div>
        <div id="squad-row" style="display:flex;gap:12px;overflow-x:auto;padding-bottom:15px;margin-bottom:20px;scrollbar-width:none;">
           <div style="color:var(--muted);font-size:11px;">Syncing cadets...</div>
        </div>
        
        <!-- Fix 4: Social Feed (Arena) -->
        <div style="font-family:var(--font-t);font-weight:700;font-size:14px;margin-bottom:15px;">THE ARENA</div>
        <div id="arena-feed" style="display:flex;flex-direction:column;gap:15px;">
            ${skeletonCards(3)}
        </div>

        <!-- Fix 12: Accountability Pacts -->
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:30px;margin-bottom:15px;">
            <span style="font-family:var(--font-t);font-weight:700;font-size:14px;">ACCOUNTABILITY PACTS</span>
            <button class="tag tag-purple" onclick="showPactModal()">+ CREATE PACT</button>
        </div>
        <div id="pacts-list" style="display:flex;flex-direction:column;gap:12px;margin-bottom:30px;">
            <div class="card" style="padding:15px;border-left:3px solid var(--purple);background:linear-gradient(90deg, rgba(124,58,237,0.05), transparent);">
                <div style="font-size:10px;color:var(--muted);margin-bottom:8px;">ACTIVE PACT: DISCIPLINE_SYNC</div>
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                    <div style="width:32px;height:32px;border-radius:50%;background:var(--card2);display:flex;align-items:center;justify-content:center;font-size:14px;border:1px solid var(--purple);">üë§</div>
                    <div style="font-size:18px;color:var(--purple);">ü§ù</div>
                    <div style="width:32px;height:32px;border-radius:50%;background:var(--card2);display:flex;align-items:center;justify-content:center;font-size:14px;border:1px solid var(--purple);">üë§</div>
                    <div style="flex:1;text-align:right;">
                        <div style="font-family:var(--font-d);font-size:18px;color:var(--text);">ACTIVE</div>
                    </div>
                </div>
                <button class="btn-outline" style="font-size:10px;padding:8px;" onclick="toast('Check-in protocol active.')">DAILY CHECK-IN</button>
            </div>
        </div>
    </div>
    <button style="position:fixed;bottom:90px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--cyan);color:var(--bg1);font-size:24px;box-shadow:0 0 20px var(--glow-c);z-index:10;display:flex;align-items:center;justify-content:center;" onclick="showPostModal()">+</button>
    `;

         initPresence();

         // Fetch real posts
         try {
            const { data: posts } = await sb.from('posts').select('*').order('created_at', { ascending: false }).limit(20);
            const feed = document.getElementById('arena-feed');
            if (feed && posts) {
               feed.innerHTML = posts.length ? posts.map(p => `
                 <div class="card" style="padding:15px;">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
                        <div style="width:36px;height:36px;border-radius:50%;background:var(--card2);display:flex;align-items:center;justify-content:center;font-size:18px;">${p.user_avatar || 'üë§'}</div>
                        <div style="flex:1;">
                            <div style="font-size:13px;font-family:var(--font-t);font-weight:700;">@${p.user_name} <span class="tag tag-cyan" style="font-size:8px;padding:2px 6px;">LVL ${p.user_level}</span></div>
                            <div style="font-size:10px;color:var(--muted);">${new Date(p.created_at).toLocaleTimeString()}</div>
                        </div>
                        <button class="btn-outline" style="width:auto;padding:4px 10px;font-size:9px;border-radius:15px;" id="follow-btn-${p.user_id}" onclick="toggleFollow('${p.user_id}', '${p.user_name}', this)">FOLLOW</button>
                    </div>
                    <div style="font-size:13px;line-height:1.5;margin-bottom:15px;">${p.content}</div>
                    <div style="display:flex;gap:15px;">
                        <span style="font-size:15px;cursor:pointer;" onclick="reactToPost('${p.id}', 'üî•')">üî• ${p.reactions?.fire || 0}</span>
                        <span style="font-size:15px;cursor:pointer;" onclick="reactToPost('${p.id}', '‚ö°')">‚ö° ${p.reactions?.zap || 0}</span>
                        <span style="font-size:15px;cursor:pointer;" onclick="toast('Reply coming soon...')">üí≠</span>
                    </div>
                 </div>
               `).join('') : '<div class="card" style="text-align:center;color:var(--muted);padding:20px;">Arena is quiet. Be the first to broadcast.</div>';
               checkFollowStatuses(posts.map(p => ({ id: p.user_id })));
            }
         } catch (e) { console.error(e); }
      }
      async function renderComms() {
         const s = document.getElementById('comms-screen');
         s.innerHTML = `
    <div style="padding:16px 20px;" class="stagger">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h1 style="font-family:var(--font-d);font-size:1.5rem;color:var(--text);letter-spacing:1px;">COMMS</h1>
            <span>üîç</span>
        </div>
        
        <div id="contacts-list" style="display:flex;flex-direction:column;gap:12px;">
            ${skeletonCards(4)}
        </div>
    </div>
    <div style="position:fixed;bottom:90px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--cyan);color:var(--bg1);font-size:24px;box-shadow:0 0 20px var(--glow-c);z-index:10;display:flex;align-items:center;justify-content:center;" onclick="toast('Direct discovery active...')">‚ûï</div>
    `;

         // Fix 3: Fetch real contacts from Supabase
         try {
            const { data: contacts } = await sb.from('users_public').select('*').neq('id', user?.id).limit(10);
            const list = document.getElementById('contacts-list');
            if (list && contacts) {
               list.innerHTML = contacts.length ? contacts.map(c => `
                <div class="card" style="padding:15px;display:flex;align-items:center;gap:15px;cursor:pointer;" onclick="openDirectChat('${c.id}', '${c.name}', '${c.avatar || 'üë§'}')">
                    <div style="width:44px;height:44px;border-radius:50%;background:var(--card2);display:flex;align-items:center;justify-content:center;font-size:20px;position:relative;">
                        ${c.avatar || 'üë§'}
                        <div id="status-${c.id}" style="position:absolute;top:0;right:0;width:12px;height:12px;background:grey;border-radius:50%;border:2px solid var(--card);"></div>
                    </div>
                    <div style="flex:1;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                            <span style="font-family:var(--font-t);font-weight:700;font-size:14px;">${c.name}</span>
                            <span class="tag tag-cyan" style="font-size:8px">LVL ${c.level || 1}</span>
                        </div>
                        <div style="font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px;">Tap to initiate transmission...</div>
                    </div>
                </div>
            `).join('') : '<div class="card" style="text-align:center;color:var(--muted);padding:20px;">No other cadets found on the frequency.</div>';
            }
         } catch (e) { console.error(e); }
      }

      function renderNotifications() {
         const s = document.getElementById('notifications-screen');
         let notifs = [];
         try { notifs = JSON.parse(localStorage.getItem('rage_notifications') || '[]'); } catch (e) { }
         // Mark all as read
         notifs = notifs.map(n => ({ ...n, read: true }));
         localStorage.setItem('rage_notifications', JSON.stringify(notifs));

         s.innerHTML = `
    <div style="padding:16px 20px;" class="stagger">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h1 style="font-family:var(--font-d);font-size:1.5rem;color:var(--text);letter-spacing:1px;">NOTIFICATIONS</h1>
            <span style="font-size:11px;color:var(--cyan);cursor:pointer;" onclick="clearAllNotifications()">Clear All</span>
        </div>
        
        <div style="display:flex;flex-direction:column;gap:10px;">
            ${notifs.length > 0 ? notifs.slice().reverse().map(n => `
                <div class="card" style="padding:15px;display:flex;gap:15px;border-left:3px solid ${n.color || 'var(--cyan)'}; ${!n.read ? 'background:rgba(0,245,255,0.03);' : ''}">
                    <div style="font-size:20px;">${n.icon || 'üì°'}</div>
                    <div style="flex:1;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                            <span style="font-family:var(--font-t);font-weight:700;font-size:13px;">${n.title}</span>
                            <span style="font-size:9px;color:var(--muted);">${getTimeAgo(n.timestamp)}</span>
                        </div>
                        <div style="font-size:11px;color:var(--muted);line-height:1.4;">${n.text}</div>
                    </div>
                </div>
            `).join('') : `
            <div class="card" style="text-align:center;padding:40px;color:var(--muted);">
                <div style="font-size:30px;margin-bottom:10px;">üì°</div>
                <div style="font-size:12px;">All quiet on the frequency, Cadet.</div>
            </div>
            `}
        </div>
    </div>
    `;
      }

      async function renderChallenges() {
         const s = document.getElementById('challenges-screen');
         s.innerHTML = `
  <div style="padding:16px 20px;" class="stagger">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h1 style="font-family: var(--font-d);font-size:1.5rem; color:var(--text); letter-spacing:1px;">CHALLENGES</h1>
      <span>üèÜ</span>
    </div>
    <div id="challenges-list" style="display:flex; flex-direction:column;gap:15px;">
      ${skeletonCards(2)}
    </div>
    <button class="btn-outline" style="width:100%; border-style:dashed;margin-top:20px;" onclick="showCreateChallenge()">
      + LAUNCH NEW CHALLENGE
    </button>
  </div>`;

         try {
            const { data: challenges } = await sb.from('challenges').select('*, challenge_participants(user_id, days_completed, user_name)').order('created_at', { ascending: false }).limit(10);
            const list = document.getElementById('challenges-list');
            if (!list) return;

            if (!challenges?.length) {
               list.innerHTML = `
      <div class="card" style="text-align:center; padding:30px;">
        <div style="font-size:30px; margin-bottom:10px;">‚öîÔ∏è</div>
        <div style="font-size:13px; color:var(--muted);">No active challenges. Be the first to launch one.</div>
      </div>`;
               return;
            }

            list.innerHTML = challenges.map(c => {
               const myEntry = c.challenge_participants?.find(p => p.user_id === user?.id);
               const totalParticipants = c.challenge_participants?.length || 0;
               const isJoined = !!myEntry;
               const daysComplete = myEntry?.days_completed || 0;
               const pct = Math.round((daysComplete / c.duration_days) * 100);
               return `
      <div class="card" style="padding:18px; ${isJoined ? 'border-color:var(--cyan);' : ''}">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <span style="font-family: var(--font-t);font-weight:700; font-size:15px;">${c.title}</span>
          <span class="tag ${isJoined ? 'tag-green' : 'tag-cyan'}">${isJoined ? 'ACTIVE' : 'OPEN'}</span>
        </div>
        <div style="font-size:11px; color:var(--muted); margin-bottom:12px;">
          ${c.description || ''} ‚Ä¢ ${c.duration_days} days ‚Ä¢ ${totalParticipants} cadets
        </div>
        ${isJoined ? `
        <div style="height:4px; background:var(--bg2); border-radius:2px; overflow:hidden; margin-bottom:6px;">
          <div style="width:${pct}%; height:100%; background:var(--green);"></div>
        </div>
        <div style="font-size:10px; color:var(--muted); margin-bottom:12px;">Day ${daysComplete} of ${c.duration_days}</div>
        <button class="btn-cyan" style="font-size:11px; padding:8px;" onclick="logChallengeDay('${c.id}')">LOG TODAY ‚úì</button>
        ` : `
        <button class="btn-outline" style="font-size:11px; padding:8px;width:100%;" onclick="joinChallenge('${c.id}', '${c.title}')">ENGAGE</button>
        `}
      </div>`;
            }).join('');
         } catch (e) { console.error('Challenges error:', e); }
      }

      async function joinChallenge(challengeId, title) {
         if (!user?.id) return;
         try {
            await sb.from('challenge_participants').insert({ challenge_id: challengeId, user_id: user.id, user_name: user.name, days_completed: 0 });
            toast('Challenge accepted!', 'var(--cyan)');
            addXP(20);
            renderChallenges();
         } catch (e) { toast('Join failed', 'var(--orange)'); }
      }

      async function logChallengeDay(challengeId) {
         if (!user?.id) return;
         try {
            const { data } = await sb.from('challenge_participants').select('days_completed, last_log').eq('challenge_id', challengeId).eq('user_id', user.id).single();
            const today = new Date().toISOString().split('T')[0];
            if (data?.last_log === today) { toast('Already logged today', 'var(--muted)'); return; }
            await sb.from('challenge_participants').update({ days_completed: (data?.days_completed || 0) + 1, last_log: today }).eq('challenge_id', challengeId).eq('user_id', user.id);
            toast('Day logged! Keep going!', 'var(--green)');
            addXP(30);
            confetti();
            renderChallenges();
         } catch (e) { toast('Log failed', 'var(--orange)'); }
      }

      function showCreateChallenge() {
         const modal = document.createElement('div');
         modal.id = 'challenge-modal';
         modal.style.cssText = `position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:500;display:flex;align-items:flex-end;`;
         modal.innerHTML = `
  <div style="width:100%; background:var(--card); border-radius:20px 20px 0 0; padding:24px; border-top:1px solid var(--border);">
    <div style="font-family:var(--font-d); font-size:14px;color:var(--cyan); margin-bottom:20px;">LAUNCH CHALLENGE</div>
    <input type="text" id="ch-title" placeholder="Challenge name..." style="margin-bottom:12px;">
    <textarea id="ch-desc" placeholder="What is the mission?" style="height:80px;resize:none; margin-bottom:12px;"></textarea>
    <div style="display:flex; gap:10px;margin-bottom:20px;">
      <select id="ch-days" style="flex:1;">
        <option value="7">7 Days</option>
        <option value="14">14 Days</option>
        <option value="21">21 Days</option>
        <option value="30" selected>30 Days</option>
      </select>
    </div>
    <div style="display:flex;gap:10px;">
      <button onclick="document.getElementById('challenge-modal').remove()" class="btn-outline" style="flex:1;">CANCEL</button>
      <button onclick="createChallenge()" class="btn-cyan" style="flex:1;">LAUNCH</button>
    </div>
  </div>`;
         document.body.appendChild(modal);
      }

      async function createChallenge() {
         const title = document.getElementById('ch-title').value.trim();
         const desc = document.getElementById('ch-desc').value.trim();
         const days = parseInt(document.getElementById('ch-days').value);
         if (!title) return toast('Add a title', 'var(--orange)');
         try {
            const { data } = await sb.from('challenges').insert({ creator_id: user.id, creator_name: user.name, title, description: desc, duration_days: days }).select().single();
            await sb.from('challenge_participants').insert({ challenge_id: data.id, user_id: user.id, user_name: user.name, days_completed: 0 });
            document.getElementById('challenge-modal').remove();
            toast('Challenge launched!', 'var(--cyan)');
            addXP(50);
            confetti();
            renderChallenges();
         } catch (e) { toast('Launch failed', 'var(--orange)'); }
      }
      /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      LIFE CYCLE & IDLE DETECTION
      ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
      let idleTime = 0;
      setInterval(() => {
         if (currentScreen === 'boot-screen' || currentScreen === 'login-screen' || currentScreen === 'signup-screen' || currentScreen === 'onboarding-screen') return;
         idleTime++;
         if (idleTime === 60) {
            document.body.style.boxShadow = 'inset 0 0 100px rgba(255,107,53,0.2)';
            toast('IDLE DETECTED. RE-ENGAGE IMMEDIATELY.', 'var(--orange)');
            if (currentScreen === 'war-room') renderWarRoom(true); // Special idle view
         }
      }, 1000);

      document.onmousemove = document.onkeypress = document.ontouchstart = () => {
         if (idleTime >= 60) {
            document.body.style.boxShadow = 'none';
            if (currentScreen === 'war-room') renderWarRoom();
         }
         idleTime = 0;
      };

      // Override renderWarRoom to handle idle state
      const originalRenderWarRoom = renderWarRoom;
      renderWarRoom = function (isIdle = false) {
         if (!isIdle) {
            originalRenderWarRoom();
            return;
         }

         const s = document.getElementById('war-room');
         const battery = getBattery();
         const lv = getLevel();

         s.innerHTML = `
    <div style="padding:40px 24px;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;" class="stagger">
        <div style="font-family:var(--font-d);font-size:12px;color:var(--orange);letter-spacing:4px;margin-bottom:20px;">STATUS: IDLE DETECTED</div>
        <div style="font-size:14px;color:var(--muted);max-width:300px;margin-bottom:40px;line-height:1.6;">Cadet, your activity levels have dropped. Re-engage immediately to maintain streak.</div>
        
        <div style="display:flex;gap:15px;width:100%;margin-bottom:40px;">
            <div class="card" style="flex:1;padding:20px;border-color:var(--orange);">
                <div style="font-family:var(--font-d);font-size:1.2rem;">LVL ${lv.lvl}</div>
                <div style="font-size:9px;color:var(--muted);">${lv.lvl >= 11 ? 'CADET RANK' : 'CADET'}</div>
            </div>
            <div class="card" style="flex:1;padding:20px;border-color:var(--orange);">
                <div style="font-family:var(--font-d);font-size:1.2rem;">${battery}%</div>
                <div style="font-size:9px;color:var(--muted);">BATTERY</div>
            </div>
        </div>
        
        <div style="width:100%;text-align:left;margin-bottom:40px;">
            <div style="font-family:var(--font-t);font-weight:700;font-size:13px;margin-bottom:15px;">RECOVER STATUS</div>
            <div style="display:flex;flex-direction:column;gap:10px;">
                <div class="card" style="padding:12px;display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:13px;">Study Modules</span>
                    <span class="tag tag-orange">3 assignments due</span>
                </div>
                <div class="card" style="padding:12px;display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:13px;">Squad Comms</span>
                    <span class="tag tag-cyan">10 new messages</span>
                </div>
            </div>
        </div>
        
        <button class="btn-orange" style="box-shadow:0 0 30px var(--glow-o);" onclick="idleTime=0;document.body.style.boxShadow='none';renderWarRoom();">ENGAGE</button>
    </div>
    `;
      };

      /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      SOCIAL & REAL-TIME LOGIC
      ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
      let currentDirectUser = null;
      let presenceChannel = null;

      async function openDirectChat(targetId, targetName, targetAvatar) {
         currentDirectUser = { id: targetId, name: targetName, avatar: targetAvatar };
         const s = document.getElementById('comms-screen');
         const convId = [user.id, targetId].sort().join('_');

         let history = [];
         try {
            const { data } = await sb.from('messages')
               .select('*')
               .eq('conversation_id', convId)
               .order('created_at', { ascending: true });
            history = data || [];
         } catch (e) { console.error(e); }

         s.innerHTML = `
    <div style="display:flex;flex-direction:column;height:100%;">
        <div style="padding:15px;display:flex;align-items:center;gap:15px;border-bottom:1px solid var(--border);background:var(--card);">
            <button onclick="renderComms()" style="background:none;color:var(--cyan);font-size:20px;">‚Üê</button>
            <div style="width:36px;height:36px;border-radius:50%;background:var(--card2);display:flex;align-items:center;justify-content:center;font-size:18px;">${targetAvatar}</div>
            <div style="flex:1;">
                <div style="font-family:var(--font-t);font-weight:700;font-size:14px;">${targetName}</div>
                <div id="typing-indicator" style="font-size:9px;color:var(--green);display:none;">typing...</div>
            </div>
        </div>
        
        <div id="dm-messages" style="flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px;">
            ${history.map(m => `
                <div style="max-width:80%; ${m.sender_id === user.id ? 'margin-left:auto;text-align:right;' : ''}">
                    <div class="card" style="padding:10px; ${m.sender_id === user.id ? 'background:rgba(0,245,255,0.05);border-color:var(--cyan);' : 'border-color:var(--purple);'}">
                        <div style="font-size:12px;line-height:1.4;">${m.content}</div>
                    </div>
                    <div style="font-size:8px;color:var(--muted);margin-top:4px;">
                        ${new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                        ${m.sender_id === user.id ? (m.read ? '<span style="color:var(--cyan)">‚úì‚úì</span>' : '‚úì') : ''}
                    </div>
                </div>
            `).join('')}
        </div>
        
        <div style="padding:15px;border-top:1px solid var(--border);display:flex;gap:10px;background:var(--bg2);">
            <input type="text" id="dm-input" placeholder="Secure link active..." style="flex:1;background:var(--card);border:1px solid var(--border);border-radius:20px;padding:8px 15px;color:var(--text);font-size:13px;" oninput="handleTyping()">
            <button onclick="sendDirectMessage()" style="background:var(--cyan);color:var(--bg1);border:none;border-radius:50%;width:35px;height:35px;display:flex;align-items:center;justify-content:center;font-size:16px;">‚û§</button>
        </div>
    </div>
    `;
         const chat = document.getElementById('dm-messages');
         if (chat) chat.scrollTop = chat.scrollHeight;

         sb.channel('convo-' + convId)
            .on('postgres_changes', {
               event: 'INSERT',
               schema: 'public',
               table: 'messages',
               filter: 'conversation_id=eq.' + convId
            }, payload => {
               appendDM(payload.new);
            }).subscribe();
      }

      function handleTyping() { }

      async function sendDirectMessage() {
         const inp = document.getElementById('dm-input');
         const content = inp.value.trim();
         if (!content || !currentDirectUser) return;
         try {
            const convId = [user.id, currentDirectUser.id].sort().join('_');
            await sb.from('messages').insert({
               conversation_id: convId,
               sender_id: user.id,
               content: content,
               read: false
            });
            inp.value = '';
         } catch (e) { toast('Error sending message', 'var(--orange)'); }
      }

      function appendDM(m) {
         const chat = document.getElementById('dm-messages');
         if (!chat) return;
         const isMe = m.sender_id === user.id;
         chat.innerHTML += `
            <div style="max-width:80%; ${isMe ? 'margin-left:auto;text-align:right;' : ''}">
                <div class="card" style="padding:10px; ${isMe ? 'background:rgba(0,245,255,0.05);border-color:var(--cyan);' : 'border-color:var(--purple);'}">
                    <div style="font-size:12px;line-height:1.4;">${m.content}</div>
                </div>
                <div style="font-size:8px;color:var(--muted);margin-top:4px;">
                    ${new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </div>
            </div>`;
         chat.scrollTop = chat.scrollHeight;
      }

      function showPostModal() {
         const modal = document.createElement('div');
         modal.id = 'post-modal';
         modal.className = 'screen active';
         modal.style.background = 'rgba(6,9,16,0.98)';
         modal.style.zIndex = '1000';
         modal.innerHTML = `
            <div style="padding:24px;" class="stagger">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;">
                    <h2 style="font-family:var(--font-d);font-size:1.2rem;color:var(--cyan);">ARENA BROADCAST</h2>
                    <button onclick="document.getElementById('post-modal').remove()" style="background:none;color:var(--muted);font-size:24px;">√ó</button>
                </div>
                <textarea id="post-text" placeholder="What is your current RAGE status, Cadet?" style="width:100%;height:150px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:15px;color:var(--text);font-family:var(--font-t);font-size:14px;margin-bottom:20px;resize:none;"></textarea>
                <div style="display:flex;gap:10px;margin-bottom:20px;overflow-x:auto;">
                    <button class="tag tag-cyan" onclick="this.parentElement.dataset.type='FLEX'">FLEX</button>
                    <button class="tag tag-purple" onclick="this.parentElement.dataset.type='GOAL'">GOAL</button>
                    <button class="tag tag-orange" onclick="this.parentElement.dataset.type='STREAK'">STREAK</button>
                    <button class="tag tag-green" onclick="this.parentElement.dataset.type='THOUGHT'">THOUGHT</button>
                </div>
                <button class="btn-cyan" onclick="createPost()">DROP IT</button>
            </div>`;
         document.body.appendChild(modal);
      }

      async function createPost() {
         const text = document.getElementById('post-text').value.trim();
         if (!text) return;
         const type = document.querySelector('#post-modal div[data-type]')?.dataset.type || 'THOUGHT';
         const lv = getLevel();
         try {
            await sb.from('posts').insert({
               user_id: user.id, user_name: user.username || user.name, user_level: lv.lvl,
               user_avatar: user.avatar || 'üë§', content: text, type: type, reactions: { fire: 0, zap: 0 }
            });
            document.getElementById('post-modal').remove();
            toast('Broadcast live.', 'var(--green)');
            renderNetwork();
         } catch (e) { toast('Transmission failed.', 'var(--orange)'); }
      }

      async function reactToPost(postId, emoji) {
         try {
            const { data: post } = await sb.from('posts').select('reactions').eq('id', postId).single();
            if (!post) return toast('Post not found', 'var(--orange)');
            const reactions = post.reactions || { fire: 0, zap: 0 };
            if (emoji === 'üî•') reactions.fire = (reactions.fire || 0) + 1;
            else if (emoji === '‚ö°') reactions.zap = (reactions.zap || 0) + 1;
            await sb.from('posts').update({ reactions }).eq('id', postId);
            toast('Reacted with ' + emoji, 'var(--cyan)');
            confetti();
            renderNetwork();
         } catch (e) { toast('Reaction failed', 'var(--orange)'); }
      }

      function initPresence() {
         if (presenceChannel) return;
         presenceChannel = sb.channel('online-users');
         presenceChannel.on('presence', { event: 'sync' }, () => {
            const state = presenceChannel.presenceState();
            updateOnlineUI(state);
            updateCommsDots(state);
         }).subscribe(async (status) => {
            if (status === 'SUBSCRIBED') {
               await presenceChannel.track({
                  id: user.id, name: user.name, level: user.level, avatar: user.avatar || 'üë§',
                  online_at: new Date().toISOString()
               });
            }
         });
      }

      function updateOnlineUI(state) {
         const squadRow = document.getElementById('squad-row');
         if (!squadRow) return;
         const users = Object.values(state).flat();
         squadRow.innerHTML = users.map(u => `
            <div style="width:50px;height:50px;border-radius:50%;border:2px solid var(--green);padding:2px;flex-shrink:0;">
                <div style="width:100%;height:100%;border-radius:50%;background:var(--card2);display:flex;align-items:center;justify-content:center;font-size:18px;">${u.avatar || 'üë§'}</div>
            </div>`).join('') || '<div style="color:var(--muted);font-size:11px;">No other cadets active.</div>';
      }

      function updateCommsDots(state) {
         const onlineIds = new Set(Object.values(state).flat().map(u => u.id));
         document.querySelectorAll('[id^="status-"]').forEach(dot => {
            const uid = dot.id.replace('status-', '');
            dot.style.background = onlineIds.has(uid) ? 'var(--green)' : 'grey';
         });
      }

      // Fix 7: Stories
      async function showStoryModal() {
         const modal = document.createElement('div');
         modal.id = 'story-modal';
         modal.className = 'screen active';
         modal.style.background = 'rgba(0,0,0,0.95)';
         modal.style.zIndex = '3000';

         const { data: stories } = await sb.from('stories').select('*').gt('created_at', new Date(Date.now() - 86400000).toISOString());
         const myStory = stories?.find(s => s.user_id === user.id);

         modal.innerHTML = `
            <div style="padding:24px;height:100%;display:flex;flex-direction:column;" class="stagger">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;">
                    <h2 style="font-family:var(--font-d);font-size:1.2rem;color:var(--cyan);">SQUAD STORIES</h2>
                    <button onclick="document.getElementById('story-modal').remove()" style="background:none;color:var(--muted);font-size:24px;">√ó</button>
                </div>
                
                ${myStory ? `
                    <div class="card" style="flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:40px;border-color:var(--cyan);">
                        <div style="font-size:10px;color:var(--cyan);letter-spacing:2px;margin-bottom:20px;">YOUR ACTIVE STORY</div>
                        <div style="font-size:18px;line-height:1.6;">${myStory.content}</div>
                        <div style="font-size:10px;color:var(--muted);margin-top:40px;">Expires in ${Math.round((new Date(myStory.created_at).getTime() + 86400000 - Date.now()) / 3600000)}h</div>
                    </div>
                ` : `
                    <div class="card" style="flex:1;display:flex;flex-direction:column;justify-content:center;padding:30px;">
                        <textarea id="story-content" placeholder="Share a fleeting thought with the squad..." style="width:100%;height:150px;background:none;border:none;color:var(--text);font-family:var(--font-t);font-size:18px;text-align:center;resize:none;outline:none;"></textarea>
                        <button class="btn-cyan" onclick="createStory()" style="margin-top:30px;">BROADCAST STORY</button>
                    </div>
                `}
                
                <div style="margin-top:30px;">
                    <div style="font-size:11px;color:var(--muted);margin-bottom:15px;letter-spacing:1px;">OTHERS</div>
                    <div style="display:flex;gap:15px;overflow-x:auto;padding-bottom:10px;">
                        ${stories?.filter(s => s.user_id !== user.id).map(s => `
                            <div style="flex-shrink:0;width:60px;text-align:center;">
                                <div style="width:56px;height:56px;border-radius:50%;border:2px solid var(--purple);padding:2px;margin-bottom:4px;">
                                    <div style="width:100%;height:100%;border-radius:50%;background:var(--card2);display:flex;align-items:center;justify-content:center;font-size:20px;">üë§</div>
                                </div>
                                <div style="font-size:9px;color:var(--muted);text-transform:uppercase;">${s.user_name}</div>
                            </div>
                        `).join('') || '<div style="font-size:11px;color:var(--muted);">Quiet in the sectors...</div>'}
                    </div>
                </div>
            </div>`;
         document.body.appendChild(modal);
      }

      async function createStory() {
         const content = document.getElementById('story-content').value.trim();
         if (!content) return;
         try {
            await sb.from('stories').insert({
               user_id: user.id,
               user_name: user.username || user.name,
               content: content
            });
            toast('Story live for 24h.', 'var(--green)');
            document.getElementById('story-modal').remove();
            renderNetwork();
         } catch (e) { toast('Story failed.', 'var(--orange)'); }
      }

      // Fix 8: Follow System
      async function toggleFollow(targetId, targetName, btn) {
         if (!user?.id || !sb) return;
         try {
            const { data: existing } = await sb
               .from('followers')
               .select('*')
               .eq('follower_id', user.id)
               .eq('following_id', targetId)
               .maybeSingle();
            if (existing) {
               await sb.from('followers')
                  .delete()
                  .eq('follower_id', user.id)
                  .eq('following_id', targetId);
               if (btn) {
                  btn.textContent = 'FOLLOW';
                  btn.style.background = '';
                  btn.style.color = '';
               }
               toast('Unfollowed', 'var(--muted)');
            } else {
               await sb.from('followers').insert({
                  follower_id: user.id,
                  following_id: targetId
               });
               if (btn) {
                  btn.textContent = 'FOLLOWING';
                  btn.style.background = 'var(--cyan)';
                  btn.style.color = 'var(--bg1)';
               }
               toast('Following ' + (targetName || 'Cadet'), 'var(--cyan)');
               addXP(5);
            }
         } catch (e) {
            toast('Follow error', 'var(--orange)');
         }
      }

      // Fix 10: Weekly Debrief
      async function generateWeeklyDebrief() {
         const btn = document.getElementById('debrief-btn');
         const content = document.getElementById('debrief-content');
         if (!btn || !content) return;

         btn.disabled = true;
         btn.innerText = 'ANALYSING...';
         content.innerHTML = '<div class="scanline"></div>Compiling mission data...';

         const completedTasks = tasks.filter(t => t.completed).length;
         const totalTasks = tasks.length;
         const stats = {
            name: user.name,
            level: user.level,
            xp: user.xp,
            streak: user.streak,
            completedTasks,
            totalTasks,
            habits: habits.length
         };

         const prompt = `Act as the RAGE OS Commander. Perform a tactical After Action Report (AAR) for cadet ${stats.name}.
         Stats: Level ${stats.level}, XP ${stats.xp}, Streak ${stats.streak}, Tasks ${stats.completedTasks}/${stats.totalTasks}, Active Habits: ${stats.habits}.
         Provide a 3-sentence high-intensity, futuristic debrief. Use military terminology (e.g., velocity, sector, mission-critical, cadence).
         Be aggressive but motivational.`;

         try {
            const aar = await callGemini(prompt);
            content.style.whiteSpace = 'pre-wrap';
            content.innerText = '';

            // Typing effect
            let i = 0;
            const type = () => {
               if (i < aar.length) {
                  content.innerText += aar[i++];
                  setTimeout(type, 20);
               } else {
                  btn.innerText = 'SHARE TO ARENA';
                  btn.disabled = false;
                  btn.onclick = () => shareDebriefToArena(aar);
               }
            };
            type();
         } catch (e) {
            content.innerText = 'Error: Link to Rage Core severed. Retrying...';
            btn.disabled = false;
            btn.innerText = 'RETRY GENERATION';
         }
      }

      async function shareDebriefToArena(text) {
         try {
            const lv = getLevel();
            await sb.from('posts').insert({
               user_id: user.id,
               user_name: user.username || user.name,
               user_level: lv.lvl,
               user_avatar: user.avatar || 'üë§',
               content: `üìä WEEKLY DEBRIEF / AAR:\n\n${text}`,
               type: 'AAR',
               reactions: { fire: 0, zap: 0 }
            });
            toast('AAR Broadcast to Arena.', 'var(--green)');
            renderRadar(); // Reset state
         } catch (e) { toast('Broadcast failed.', 'var(--orange)'); }
      }

      // Fix 11: Study Timer
      let studyInterval = null;
      let studySeconds = 0;
      let studyActive = false;
      let studyTotalSeconds = 1500;

      function showStudyTimer() {
         const modal = document.createElement('div');
         modal.id = 'timer-modal';
         modal.className = 'screen active';
         modal.style.background = 'var(--bg1)';
         modal.style.zIndex = '2000';
         modal.innerHTML = `
            <div style="padding:24px;display:flex;flex-direction:column;align-items:center;height:100%;" class="stagger">
                <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:60px;">
                    <h2 style="font-family:var(--font-d);font-size:1.2rem;color:var(--cyan);">FOCUS PROTOCOL</h2>
                    <button onclick="closeStudyTimer()" style="background:none;color:var(--muted);font-size:24px;">√ó</button>
                </div>
                
                <div style="width:280px;height:280px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;position:relative;margin-bottom:60px;box-shadow:inset 0 0 50px rgba(0,245,255,0.05);">
                    <div id="timer-display" style="font-family:var(--font-d);font-size:4rem;color:var(--text);letter-spacing:4px;">25:00</div>
                    <svg style="position:absolute;top:-5;left:-5;width:290px;height:290px;transform:rotate(-90deg);">
                        <circle cx="145" cy="145" r="140" fill="none" stroke="var(--cyan)" stroke-width="4" stroke-dasharray="880" stroke-dashoffset="0" id="timer-progress" style="transition:stroke-dashoffset 1s linear;"></circle>
                    </svg>
                </div>
                
                <div style="display:flex;gap:15px;margin-bottom:40px;">
                    <button class="tag" style="padding:10px 20px;" onclick="setTimerDuration(1500)">25M</button>
                    <button class="tag" style="padding:10px 20px;" onclick="setTimerDuration(3000)">50M</button>
                    <button class="tag" style="padding:10px 20px;" onclick="setTimerDuration(600)">10M</button>
                </div>
                
                <div style="display:flex;gap:20px;width:100%;">
                    <button id="study-start-btn" class="btn-cyan" style="flex:2;" onclick="toggleStudyTimer()">START</button>
                    <button class="btn-outline" style="flex:1;" onclick="resetStudyTimer()">RESET</button>
                </div>
            </div>`;
         document.body.appendChild(modal);
      }

      function setTimerDuration(sec) {
         studySeconds = sec;
         studyTotalSeconds = sec;
         updateTimerDisplay();
      }

      function updateTimerDisplay() {
         const m = Math.floor(studySeconds / 60);
         const s = studySeconds % 60;
         const d = document.getElementById('timer-display');
         if (d) d.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;

         const progress = document.getElementById('timer-progress');
         if (progress && studyTotalSeconds > 0) {
            const pct = (studySeconds / studyTotalSeconds) * 880;
            progress.style.strokeDashoffset = 880 - pct;
         }
      }

      function toggleStudyTimer() {
         const btn = document.getElementById('study-start-btn');
         if (studyActive) {
            clearInterval(studyInterval);
            studyActive = false;
            btn.innerText = 'RESUME';
         } else {
            if (studySeconds <= 0) studySeconds = 1500;
            studyActive = true;
            btn.innerText = 'PAUSE';
            studyInterval = setInterval(() => {
               studySeconds--;
               updateTimerDisplay();
               if (studySeconds <= 0) {
                  clearInterval(studyInterval);
                  finishStudySession();
               }
            }, 1000);
         }
      }

      function resetStudyTimer() {
         clearInterval(studyInterval);
         studyActive = false;
         studySeconds = 1500;
         updateTimerDisplay();
         const btn = document.getElementById('study-start-btn');
         if (btn) btn.innerText = 'START';
      }

      function finishStudySession() {
         const hoursStudied = studyTotalSeconds / 3600;
         dailyLog.studyHours = (dailyLog.studyHours || 0) + hoursStudied;
         dailyLog.date = new Date().toDateString();
         save();
         if (sb && user?.id) {
            sb.from('daily_logs').upsert({
               user_id: user.id,
               date: new Date().toDateString(),
               mood: dailyLog.mood,
               study_hours: dailyLog.studyHours,
               workout: dailyLog.workout || false,
               sleep_on_time: dailyLog.sleepOnTime || false,
               battery_score: getBattery()
            }).catch(() => { });
         }
         toast('MISSION SUCCESS. +50 XP', 'var(--green)');
         confetti();
         addXP(50);
         closeStudyTimer();
      }

      function closeStudyTimer() {
         clearInterval(studyInterval);
         studyActive = false;
         const m = document.getElementById('timer-modal');
         if (m) m.remove();
      }

      // Fix 12: Accountability Pacts
      function showPactModal() {
         const modal = document.createElement('div');
         modal.id = 'pact-modal';
         modal.className = 'screen active';
         modal.style.background = 'var(--bg1)';
         modal.style.zIndex = '3000';
         modal.innerHTML = `
            <div style="padding:24px;" class="stagger">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;">
                    <h2 style="font-family:var(--font-d);font-size:1.2rem;color:var(--purple);">CREATE PACT</h2>
                    <button onclick="document.getElementById('pact-modal').remove()" style="background:none;color:var(--muted);font-size:24px;">√ó</button>
                </div>
                
                <div class="card" style="padding:20px;margin-bottom:20px;">
                    <div style="font-size:11px;color:var(--muted);margin-bottom:10px;">SELECT SQUAD MATE</div>
                    <select id="pact-target" style="width:100%;margin-bottom:20px;background:var(--card);border:1px solid var(--border);color:var(--text);padding:10px;border-radius:8px;">
                        <option value="">Scanning for active cadets...</option>
                    </select>
                    
                    <div style="font-size:11px;color:var(--muted);margin-bottom:10px;">THE PACT GOAL</div>
                    <input type="text" id="pact-goal" placeholder="e.g., No Sugar, 5AM Wakeup, 4h Study" style="width:100%;background:var(--card);border:1px solid var(--border);color:var(--text);padding:10px;border-radius:8px;margin-bottom:20px;">
                    
                    <div style="background:rgba(124,58,237,0.1);padding:15px;border-radius:8px;border-left:3px solid var(--purple);margin-bottom:20px;">
                        <div style="font-size:11px;color:var(--purple);font-weight:700;margin-bottom:5px;">THE CONSEQUENCE</div>
                        <p style="font-size:10px;color:var(--muted);line-height:1.4;">If either party fails to check in, the shared streak will reset to zero. Total XP penalty: -50.</p>
                    </div>
                    
                    <button class="btn-cyan" style="background:var(--purple);box-shadow:0 0 20px rgba(124,58,237,0.3);" onclick="createPact()">INITIATE PACT</button>
                </div>
            </div>`;
         document.body.appendChild(modal);

         // Fetch contacts for the dropdown
         sb.from('users_public').select('*').neq('id', user.id).limit(20)
            .then(({ data }) => {
               const sel = document.getElementById('pact-target');
               if (sel && data) {
                  sel.innerHTML = data.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
               }
            });
      }

      async function createPact() {
         const targetId = document.getElementById('pact-target').value;
         const goal = document.getElementById('pact-goal').value.trim();
         if (!targetId || !goal) return toast('Target and Goal required.', 'var(--orange)');

         try {
            await sb.from('accountability_pacts').insert({
               user1_id: user.id,
               user2_id: targetId,
               user1_name: user.username || user.name,
               title: goal,
               streak: 0,
               last_logged: new Date().toISOString().split('T')[0]
            });
            toast('Pact Initiated. Awaiting synchronization.', 'var(--purple)');
            document.getElementById('pact-modal').remove();
            renderNetwork();
         } catch (e) { toast('Transmission failed.', 'var(--orange)'); }
      }

      // ‚îÄ‚îÄ‚îÄ NF4: Notification System ‚îÄ‚îÄ‚îÄ
      function addNotification(title, text, icon = 'üì°', color = 'var(--cyan)') {
         let notifs = [];
         try { notifs = JSON.parse(localStorage.getItem('rage_notifications') || '[]'); } catch (e) { }
         notifs.push({ title, text, icon, color, timestamp: Date.now(), read: false });
         if (notifs.length > 50) notifs = notifs.slice(-50);
         localStorage.setItem('rage_notifications', JSON.stringify(notifs));
      }

      function getTimeAgo(ts) {
         if (!ts) return '';
         const diff = Date.now() - ts;
         const mins = Math.floor(diff / 60000);
         if (mins < 1) return 'just now';
         if (mins < 60) return mins + 'm ago';
         const hrs = Math.floor(mins / 60);
         if (hrs < 24) return hrs + 'h ago';
         const days = Math.floor(hrs / 24);
         return days + 'd ago';
      }

      function clearAllNotifications() {
         localStorage.setItem('rage_notifications', '[]');
         renderNotifications();
         toast('All notifications cleared', 'var(--muted)');
      }

      // ‚îÄ‚îÄ‚îÄ NF2: Study Log Functions ‚îÄ‚îÄ‚îÄ
      function logStudyHours(val) {
         const hrs = parseFloat(val) || 0;
         dailyLog.studyHours = hrs;
         dailyLog.date = new Date().toDateString();
         save();
         if (hrs > 0) {
            addXP(Math.round(hrs * 10));
            addNotification('Study Logged', `${hrs}h of study recorded. Keep grinding!`, 'üìö', 'var(--cyan)');
         }
         if (sb && user?.id) {
            sb.from('daily_logs').upsert({
               user_id: user.id, date: new Date().toDateString(),
               study_hours: hrs, mood: dailyLog.mood, workout: dailyLog.workout || false,
               battery_score: getBattery()
            }).catch(() => { });
         }
      }

      function toggleWorkout() {
         dailyLog.workout = !dailyLog.workout;
         dailyLog.date = new Date().toDateString();
         save();
         if (dailyLog.workout) {
            addXP(15);
            addNotification('Workout Done!', 'Great job staying active. +15 XP', 'üí™', 'var(--green)');
            toast('Workout logged! +15 XP', 'var(--green)');
         }
         if (sb && user?.id) {
            sb.from('daily_logs').upsert({
               user_id: user.id, date: new Date().toDateString(),
               workout: dailyLog.workout, study_hours: dailyLog.studyHours || 0,
               mood: dailyLog.mood, battery_score: getBattery()
            }).catch(() => { });
         }
         renderWarRoom();
      }

      // ‚îÄ‚îÄ‚îÄ Fix 6 + NF1: Edit Profile + Avatar Upload ‚îÄ‚îÄ‚îÄ
      function showEditProfile() {
         const modal = document.createElement('div');
         modal.id = 'edit-profile-modal';
         modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:5000;overflow-y:auto;';
         const allSubjects = ['Mathematics', 'Physics', 'Chemistry', 'Biology', 'English', 'History', 'Economics', 'Computer Science', 'Political Science', 'Psychology', 'Sociology', 'Hindi', 'Geography'];
         modal.innerHTML = `
         <div style="padding:24px;max-width:440px;margin:0 auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;">
               <h2 style="font-family:var(--font-d);font-size:1.2rem;color:var(--cyan);">EDIT PROFILE</h2>
               <button onclick="document.getElementById('edit-profile-modal').remove()" style="background:none;color:var(--muted);font-size:24px;">√ó</button>
            </div>
            
            <div style="text-align:center;margin-bottom:30px;">
               <div id="avatar-preview" style="width:80px;height:80px;border-radius:50%;background:var(--card);border:2px solid var(--cyan);display:flex;align-items:center;justify-content:center;font-size:36px;margin:0 auto 10px;overflow:hidden;">
                  ${user?.avatar_url ? `<img src="${user.avatar_url}" style="width:100%;height:100%;object-fit:cover;">` : (user?.name?.[0]?.toUpperCase() || '?')}
               </div>
               <label style="font-size:11px;color:var(--cyan);cursor:pointer;">
                  CHANGE PHOTO
                  <input type="file" id="avatar-file" accept="image/*" style="display:none;" onchange="previewAvatar(this)">
               </label>
            </div>

            <div style="display:flex;flex-direction:column;gap:15px;">
               <div>
                  <label style="font-size:10px;color:var(--muted);letter-spacing:1px;">NAME</label>
                  <input type="text" id="edit-name" value="${user?.name || ''}" style="margin-top:4px;">
               </div>
               <div>
                  <label style="font-size:10px;color:var(--muted);letter-spacing:1px;">USERNAME</label>
                  <input type="text" id="edit-username" value="${user?.username || ''}" style="margin-top:4px;">
               </div>
               <div>
                  <label style="font-size:10px;color:var(--muted);letter-spacing:1px;">BIO</label>
                  <textarea id="edit-bio" style="margin-top:4px;height:60px;resize:none;">${user?.bio || ''}</textarea>
               </div>
               <div>
                  <label style="font-size:10px;color:var(--muted);letter-spacing:1px;">LOCATION</label>
                  <input type="text" id="edit-location" value="${user?.location || ''}" style="margin-top:4px;">
               </div>
               <div style="display:flex;gap:10px;">
                  <div style="flex:1;">
                     <label style="font-size:10px;color:var(--muted);letter-spacing:1px;">STUDY TARGET (h/day)</label>
                     <input type="number" id="edit-study-target" value="${user?.studyTarget || 4}" min="1" max="16" style="margin-top:4px;">
                  </div>
                  <div style="flex:1;">
                     <label style="font-size:10px;color:var(--muted);letter-spacing:1px;">WAKE TIME</label>
                     <input type="time" id="edit-wake" value="${user?.wakeTime || '06:00'}" style="margin-top:4px;">
                  </div>
                  <div style="flex:1;">
                     <label style="font-size:10px;color:var(--muted);letter-spacing:1px;">SLEEP TIME</label>
                     <input type="time" id="edit-sleep" value="${user?.sleepTime || '23:00'}" style="margin-top:4px;">
                  </div>
               </div>
               <div>
                  <label style="font-size:10px;color:var(--muted);letter-spacing:1px;">SUBJECTS</label>
                  <div id="edit-subjects" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;">
                     ${allSubjects.map(s => `<button onclick="toggleSubject(this,'${s}')" class="tag ${(user?.subjects || []).includes(s) ? 'tag-cyan' : ''}" style="cursor:pointer;padding:6px 12px;">${s}</button>`).join('')}
                  </div>
               </div>
            </div>
            
            <button class="btn-cyan" style="margin-top:30px;" onclick="saveProfile()">SAVE CHANGES</button>
         </div>`;
         document.body.appendChild(modal);
      }

      function toggleSubject(btn, subject) {
         btn.classList.toggle('tag-cyan');
      }

      function previewAvatar(input) {
         if (input.files && input.files[0]) {
            if (input.files[0].size > 2 * 1024 * 1024) {
               toast('Max 2MB file size', 'var(--orange)');
               input.value = '';
               return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
               const preview = document.getElementById('avatar-preview');
               preview.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;">`;
            };
            reader.readAsDataURL(input.files[0]);
         }
      }

      async function saveProfile() {
         const name = document.getElementById('edit-name').value.trim();
         const username = document.getElementById('edit-username').value.trim();
         const bio = document.getElementById('edit-bio').value.trim();
         const location = document.getElementById('edit-location').value.trim();
         const studyTarget = parseInt(document.getElementById('edit-study-target').value) || 4;
         const wakeTime = document.getElementById('edit-wake').value || '06:00';
         const sleepTime = document.getElementById('edit-sleep').value || '23:00';
         const subjects = [...document.querySelectorAll('#edit-subjects .tag-cyan')].map(b => b.textContent);

         if (!name) return toast('Name is required', 'var(--orange)');

         user.name = name;
         user.username = username;
         user.bio = bio;
         user.location = location;
         user.studyTarget = studyTarget;
         user.wakeTime = wakeTime;
         user.sleepTime = sleepTime;
         user.subjects = subjects;

         // Handle avatar upload
         const fileInput = document.getElementById('avatar-file');
         if (fileInput?.files?.[0] && sb) {
            try {
               const file = fileInput.files[0];
               const ext = file.name.split('.').pop();
               const path = `${user.id}/avatar.${ext}`;
               await sb.storage.from('avatars').upload(path, file, { upsert: true });
               const { data: urlData } = sb.storage.from('avatars').getPublicUrl(path);
               user.avatar_url = urlData.publicUrl;
            } catch (e) {
               console.error('Avatar upload error:', e);
               toast('Avatar upload failed, profile saved without it', 'var(--orange)');
            }
         }

         save();

         if (sb && user?.id) {
            try {
               await sb.from('users_public').upsert({
                  id: user.id, name, username, bio, location,
                  study_target: studyTarget, wake_time: wakeTime, sleep_time: sleepTime,
                  subjects, avatar_url: user.avatar_url || null,
                  xp: user.xp || 0, streak: user.streak || 0, level: getLevel().lvl
               });
            } catch (e) { console.error('Profile sync error:', e); }
         }

         document.getElementById('edit-profile-modal')?.remove();
         toast('Profile updated!', 'var(--green)');
         renderCommander();
      }

      // Initial setup
      window.onload = async () => {
         if (!sb) return;
         try {
            const { data: { session } } = await sb.auth.getSession();
            if (session && session.user) {
               const { data: profile } = await sb.from('users_public').select('*').eq('id', session.user.id).single();
               user = {
                  ...session.user,
                  ...(profile || {}),
                  name: profile?.name || session.user.user_metadata?.name || session.user.email.split('@')[0]
               };
               save();
            }
         } catch (e) {
            console.log('Session check failed:', e);
         }
      };
   </script>
</body>

<!--
DEPLOYMENT FILES NEEDED:

1. Create vercel.json in same folder:
{
  "version": 2,
  "builds": [
    {
      "src": "index.html",
      "use": "@vercel/static"
    }
  ],
  "routes": [
    {
      "src": "/(.*)",
      "dest": "/index.html"
    }
  ]
}

2. DEPLOY STEPS:
   a) Go to github.com
   b) New repo ‚Üí name: rage-os ‚Üí private
   c) Upload index.html + vercel.json
   d) Go to vercel.com
   e) Import GitHub repo
   f) Click Deploy
   g) Done ‚Äî app is live

3. CUSTOM DOMAIN (optional):
   a) Buy domain on namecheap.com
      suggested: rage-app.in (~‚Çπ800/yr)
   b) In Vercel: Settings ‚Üí Domains
   c) Add your domain
   d) Follow DNS setup instructions
   e) Done in 10 minutes

4. SUPABASE REDIRECT URL:
   After deploying update Supabase:
   Authentication ‚Üí URL Configuration
   Site URL: https://your-app.vercel.app
   Redirect URLs: 
     https://your-app.vercel.app/**
-->

</html>